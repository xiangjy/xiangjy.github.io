
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Xiangjy&#39;s Blog">
    <title>归档: 2019 - Xiangjy&#39;s Blog</title>
    <meta name="author" content="Xiangjy">
    
    
        <link rel="icon" href="http://localhost:4000/assets/images/dx.png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Xiangjy&#39;s Blog">
<meta property="og:url" content="http://localhost:4000/archives/2019/index.html">
<meta property="og:site_name" content="Xiangjy&#39;s Blog">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xiangjy&#39;s Blog">
    
    
        
    
    
        <meta property="og:image" content="http://localhost:4000/assets/images/dx.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

    
</head>

    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Xiangjy&#39;s Blog</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/dx.png" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/dx.png" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Xiangjy</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="#search" title="搜索">
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="http://stackoverflow.com/users" target="_blank" rel="noopener" title="Stack Overflow">
                    
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://twitter.com/" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://facebook.com/" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://plus.google.com/" target="_blank" rel="noopener" title="Google Plus">
                    
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Plus</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.linkedin.com/profile/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/mailto" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/06/05/Redis Sentinel/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-05T11:23:30+08:00">
	
		    6月 05, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Redis-Sentinel"><a href="#Redis-Sentinel" class="headerlink" title="Redis Sentinel"></a>Redis Sentinel</h1><p>1.port 26379</p>
<p>sentinel监听端口，默认是26379，可以修改。</p>
<p>2.sentinel monitor <master-name> <ip> <redis-port> <quorum></quorum></redis-port></ip></master-name></p>
<p>告诉sentinel去监听地址为ip:port的一个master，这里的master-name可以自定义，quorum是一个数字，指明当有多少个sentinel认为一个master失效时，master才算真正失效。master-name只能包含英文字母，数字，和“.-_”这三个字符需要注意的是master-ip 要写真实的ip地址而不要用回环地址（127.0.0.1）。</p>
<p>配置示例：</p>
<p>sentinel monitor mymaster 192.168.0.5 6379 2</p>
<p>3.sentinel auth-pass <master-name> <password></password></master-name></p>
<p>设置连接master和slave时的密码，注意的是sentinel不能分别为master和slave设置不同的密码，因此master和slave的密码应该设置相同。</p>
<p>配置示例：</p>
<p>sentinel auth-pass mymaster 0123passw0rd</p>
<p>4.sentinel down-after-milliseconds <master-name> <milliseconds> </milliseconds></master-name></p>
<p>这个配置项指定了需要多少失效时间，一个master才会被这个sentinel主观地认为是不可用的。 单位是毫秒，默认为30秒</p>
<p>配置示例：</p>
<p>sentinel down-after-milliseconds mymaster 30000</p>
<p>5.sentinel parallel-syncs <master-name> <numslaves> </numslaves></master-name></p>
<p>这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。</p>
<p>配置示例：</p>
<p>sentinel parallel-syncs mymaster 1</p>
<p>\6. sentinel failover-timeout <master-name> <milliseconds></milliseconds></master-name></p>
<p>failover-timeout 可以用在以下这些方面： </p>
<p>​      \1. 同一个sentinel对同一个master两次failover之间的间隔时间。</p>
<p>​      \2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</p>
<p>​      3.当想要取消一个正在进行的failover所需要的时间。  </p>
<p>​      4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了。</p>
<p>配置示例：</p>
<p>sentinel failover-timeout mymaster1 20000</p>
<p>7.sentinel的notification-script和reconfig-script是用来配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。对于脚本的运行结果有以下规则：</p>
<p>​        若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10</p>
<p>​        若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</p>
<p>​        如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</p>
<p>​        一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</p>
<p>1).sentinel notification-script <master-name> <script-path> </script-path></master-name></p>
<p>通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。</p>
<p>  配置示例：</p>
<p> sentinel notification-script mymaster /var/redis/notify.sh</p>
<p>2).sentinel client-reconfig-script <master-name> <script-path></script-path></master-name></p>
<p> 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。以下参数将会在调用脚本时传给脚本:</p>
<p>​       <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port></to-port></to-ip></from-port></from-ip></state></role></master-name></p>
<p>目前<state>总是“failover”, <role>是“leader”或者“observer”中的一个。 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的。这个脚本应该是通用的，能被多次调用，不是针对性的。</role></state></p>
<p>   配置示例：</p>
<p>   sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</p>
<h3 id="其他文章"><a href="#其他文章" class="headerlink" title="其他文章"></a>其他文章</h3><p><a href="http://shouce.jb51.net/redis-all-about/HAClusterArchPractice/ms/event-noti.html" target="_blank" rel="noopener">http://shouce.jb51.net/redis-all-about/HAClusterArchPractice/ms/event-noti.html</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/06/05/Redis Sentinel/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/06/03/Gitlab 免密/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-03T23:34:48+08:00">
	
		    6月 03, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Gitlab-免密"><a href="#Gitlab-免密" class="headerlink" title="Gitlab 免密"></a>Gitlab 免密</h1><p>1、创建一个 SSH key</p>
<p>$ ssh-keygen -t rsa -f xxxx -C “xiangjy@outlook.com”</p>
<p>代码参数含义：</p>
<p>-t 指定密钥类型，默认是 rsa ，可以省略。</p>
<p>-C 设置注释文字，比如邮箱。</p>
<p>-f 指定密钥文件存储文件名。</p>
<p>生成 id_rsa 和 id_rsa.pub 两个秘钥文件。</p>
<p>2、添加SSH key 到 Gitlab</p>
<p>$ clip &lt; ~/.ssh/id_rsa.pub</p>
<p>Account settings -&gt; SSH key</p>
<p>3、Gitlab 自定义SSH 端口全局配置</p>
<p>Gitlab自定义端口设置：</p>
<p>~/.ssh目录下创建config文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host git域名</span><br><span class="line">HostName git域名</span><br><span class="line">Port 2800</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<p>4、ssh文件夹及文件权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~</span><br><span class="line">$ chmod 700 .ssh</span><br><span class="line">$ cd ~/.ssh</span><br><span class="line">$ chmod 600 *</span><br></pre></td></tr></table></figure>
                    
                        

                    
                    
                        <p>
                            <a href="/2019/06/03/Gitlab 免密/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/04/12/Nginx/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-12T09:54:52+08:00">
	
		    4月 12, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h3 id="我眼中的-Nginx（一）：Nginx-和位运算"><a href="#我眼中的-Nginx（一）：Nginx-和位运算" class="headerlink" title="我眼中的 Nginx（一）：Nginx 和位运算"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOgyAURE8jSwJ-EFywsFrvgYhCi9ZYTGtP399VM5PJyywmMxrJdUWiKRmvmUABB6Yop50WZdeqq2ZN0_G2LwRbbEz02M5jpe6xkGA8SA-2ckMN4BwMk9AWpJosgHKjZmQxNXCukZIJOW_PApqi7NHZu_DfwsLuObrkkUBpTE5DXhLZzS2u82nXmb4jJt74BI9NpL8Jks2xXeLL-3s6ZT2uX-dyP1c" target="_blank" rel="noopener"><strong>我眼中的 Nginx（一）：Nginx 和位运算</strong></a></h3><p>众所周知 Nginx 以性能而出名，这和它优秀的代码实现有着密切的关系，而本文所要讲述的——位运算，也是促成 Nginx 优秀性能的原因之一。</p>
<p><strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（二）：HTTP-2-dynamic-table-size-update"><a href="#我眼中的-Nginx（二）：HTTP-2-dynamic-table-size-update" class="headerlink" title="我眼中的 Nginx（二）：HTTP/2 dynamic table size update"></a><a href="http://email.mail.upyun.com/c/eJxFjsEOgjAQRL-GHptd2sJy6AFB_wPLYqsFiZYofr31ZGYymczhZUZrkCoRbAnYgM5SqKCWKHvSZd_VR4K27bE7FRrmIUS5rfu2SHefhbc01eC0NiNPFQCPzhimqjR0npgn48RsG4VIBCJan9L6LFRblKfsxM7_WXkYHim4yLkpwpwofZqjeNhrWC77sFzkO-TMNz6e8xLkDyGS3dZDeDHf4m6acfkC_40_kw" target="_blank" rel="noopener"><strong>我眼中的 Nginx（二）：HTTP/2 dynamic table size update</strong></a></h3><p>HTTP/2 使用了 HPACK 来压缩头部，通过使用索引替代原始的文本来减少传输的字节数。</p>
<p><strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（三）：Nginx-变量和变量插值"><a href="#我眼中的-Nginx（三）：Nginx-变量和变量插值" class="headerlink" title="我眼中的 Nginx（三）：Nginx 变量和变量插值"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOwiAURE9TloTfD_azYFFbvQcCCkprozRaTy-uzEwmk1m8jDcKaMeSaQVoIasQUHQc-EiyHYfuQKLvRxiOjRSTTZmvy7bO3N0nFo2SSA6URrK-E-LspNeddSdUOzifyLPJaAQgEiybWMrybLBv2mN1CS7-WXWwj5JcDrUhYU3gsUyZPcw1zZfNzhf-TjXrjU8MdUn8h2DFrMs-vUK45U1pP38BrkU--g" target="_blank" rel="noopener"><strong>我眼中的 Nginx（三）：Nginx 变量和变量插值</strong></a></h3><p>Nginx 允许我们在配置文件里嵌入”变量”，这些变量由 Nginx 的各个模块定义，其目的是为了提升配置的灵活性。<strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（四）：是什么让你的-Nginx-服务退出这么慢？"><a href="#我眼中的-Nginx（四）：是什么让你的-Nginx-服务退出这么慢？" class="headerlink" title="我眼中的 Nginx（四）：是什么让你的 Nginx 服务退出这么慢？"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOgyAURE8jS8L3g-KChdV6DxRaaNEai2nt6fu7amYymbzFZJxRoCsWTSmgEZKEgKLmwHsty76rz1q0bQ_dUEgx25j4vh77wqfHzILxQqKqnZ5GqawWmiwvHgBHiVg5z2bTIABxlkzIeX0W2BblQM5-Cv8tAnbLcUqeGmpFCTzkObHN3OJyPexy5e9ISTc-wROJ_DfBstnXU3x5f0-HatzyBYFzPpc" target="_blank" rel="noopener"><strong>我眼中的 Nginx（四）：是什么让你的 Nginx 服务退出这么慢？</strong></a></h3><p>本文将介绍 Nginx worker 进程退出时的准备步骤，延缓退出的原因，并介绍对应的解决办法。</p>
<p><strong>了解详情</strong></p>
<p><a href="http://email.mail.upyun.com/c/eJxFjk0OwiAUhE9TluQ96A8sWNTW3gMpFRSwqTRaTy-uzEwmk1l8mVk1KFriFQOUUBdx5NBRpKOo2Th0ZwF9P-IwVTVE7QPd12NP1DwiccpotsxNqxfQlqGUwoDsQF6skAta05GoJEcUAkhQLuf1WfG-YlNxtsb9WWXQW_Ym2NK4aEsidTkGsqmbT9dDpyt9-5LlxsfZsnj6Q5Cs9vXkX9bew9HIOX0B75Q_ZQ" target="_blank" rel="noopener"><strong>我眼中的 Nginx（五）：Nginx — 子请求设计之道</strong></a><br>使用子请求机制的意义在于，它能够分散原本集中在单个请求里的处理逻辑，简化任务，大大降低请求的复杂度。<strong>了解详情</strong></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/04/12/Nginx/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/04/08/MySQL/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-08T10:45:33+08:00">
	
		    4月 08, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>###安装mysql</p>
<p>CentOS默认不支持mysql</p>
<p>yum remove mariadb-server<br>cd /var/lib &amp;&amp; rm -rfv mysql<br>yum install mariadb-server</p>
<p>###添加远程访问用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'new_root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'***'</span>;</span><br><span class="line">  <span class="keyword">GRANT</span> ALL <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'new_root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'***'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span> MAX_QUERIES_PER_HOUR <span class="number">0</span> MAX_CONNECTIONS_PER_HOUR <span class="number">0</span> MAX_UPDATES_PER_HOUR <span class="number">0</span> MAX_USER_CONNECTIONS <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/04/08/MySQL/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/19/Redis字符串/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-19T09:12:53+08:00">
	
		    2月 19, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Redis字符串"><a href="#Redis字符串" class="headerlink" title="Redis字符串"></a>Redis字符串</h1><h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>Redis没有直接使用C语言传统的字符串表示（以空字符结尾的字符数组，以下简称C字符串），而是自己构建了一种名为简单动态字符串（simple dynamic string，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。比如说 “SET name kobe”这个命令，redis将在数据库中创建一个键值对。</p>
<p>键值对的键是一个字符串对象，对象的底层实现是一个保存着字符串“name”的SDS</p>
<p>键值对的值是一个字符串对象，对象的底层实现是一个保存着字符串“kobe”的SDS</p>
<p>下图可以解释SDS的数据结构</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/c76ddab18f05469abbd36156cce071b7" alt="原来redis是这样存字符串的"></p>
<ul>
<li>free属性的值为0，表示这个SDS没有分配任何未使用空间。</li>
<li>len属性的值为5，表示这个SDS保存了一个五字节长的字符串。</li>
<li>buf属性是一个char类型的数组，数组的前五个字节分别保存了’R’、’e’、’d’、’i’、’s’五个字符，而最后一个字节则保存了空字符’’</li>
</ul>
<p>与C字符串相比，SDS具有以下优点：</p>
<h1 id="获取字符串长度的时间复杂度为O-1"><a href="#获取字符串长度的时间复杂度为O-1" class="headerlink" title="获取字符串长度的时间复杂度为O(1)"></a>获取字符串长度的时间复杂度为O(1)</h1><p>C语言使用长度为N+1的字符数组来表示长度为N的字符串，并且字符数组的最后一个元素总是空字符’’。</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/046a00507bac4e0b84d3fbf7c947c631" alt="原来redis是这样存字符串的"></p>
<p>因为C字符串并不记录自身的长度信息，所以为了获取一个C字符串的长度，程序必须遍历整个字符串，对遇到的每个字符进行计数，直到遇到代表字符串结尾的空字符为止，这个操作的复杂度为<strong>O(N)</strong>。和C字符串不同，因为SDS在len属性中记录了SDS本身的长度，所以获取一个SDS长度的复杂度仅为O(1)。</p>
<h1 id="杜绝缓冲区溢出"><a href="#杜绝缓冲区溢出" class="headerlink" title="杜绝缓冲区溢出"></a>杜绝缓冲区溢出</h1><p>举个例子，假设程序里有两个在内存中紧邻着的C字符串s1和s2，其中s1保存了字符串”Redis”，而s2则保存了字符串”MongoDB</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/0c76350300c344e785638e9d00c3cdc6" alt="原来redis是这样存字符串的"></p>
<p>如果一个程序员决定通过执行</p>
<p>strcat(s1, “ Cluster”)</p>
<p>将s1的内容修改为”Redis Cluster”，但粗心的他却忘了在执行strcat之前为s1分配足够的空间，那么在strcat函数执行之后，s1的数据将溢出到s2所在的空间中，导致s2保存的内容被意外地修改。与C字符串不同，SDS的空间分配策略完全杜绝了发生缓冲区溢出的可能性：当SDS API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求，如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小，然后才执行实际的修改操作，所以使用SDS既不需要手动修改SDS的空间大小，也不会出现前面所说的缓冲区溢出问题。</p>
<h1 id="减少修改字符串长度时所需的内存重分配次数"><a href="#减少修改字符串长度时所需的内存重分配次数" class="headerlink" title="减少修改字符串长度时所需的内存重分配次数"></a>减少修改字符串长度时所需的内存重分配次数</h1><ul>
<li>空间预分配</li>
</ul>
<p>空间预分配用于优化SDS的字符串增长操作：当SDS的API对一个SDS进行修改，并且需要对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必须要的空间，还会为SDS分配额外的未使用空间。其中，额外分配的未使用空间数量由以下公式决定：</p>
<p>如果对SDS进行修改之后，SDS的长度（也即是len属性的值）将小于1MB，那么程序分配和len属性同样大小的未使用空间，这时SDS len属性的值将和free属性的值相同。举个例子，如果进行修改之后，SDS的len将变成13字节，那么程序也会分配13字节的未使用空间，SDS的buf数组的实际长度将变成13+13+1=27字节（额外的一字节用于保存空字符）。如果对SDS进行修改之后，SDS的长度将大于等于1MB，那么程序会分配1MB的未使用空间。举个例子，如果进行修改之后，SDS的len将变成30MB，那么程序会分配1MB的未使用空间，SDS的buf数组的实际长度将为30MB+1MB+1byte。举个例子：</p>
<p>如果存在“redis”SDS如下图：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/e667f1a9003143c184125d223b8838ae" alt="原来redis是这样存字符串的"></p>
<p>执行：</p>
<p>strcat(s1, “ Cluster”)</p>
<p>那么sdscat将执行一次内存重分配操作，将SDS的长度修改为13字节，并将SDS的未使用空间同样修改为13字节，如下图所示：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/f9ddf635f4424b32a85e58d25d059ffe" alt="原来redis是这样存字符串的"></p>
<p>如果这时我们再次执行</p>
<p>strcat(s1, “ Tutorial”)</p>
<p>那么这次sdscat将不需要执行内存重分配，因为未使用空间里面的13字节足以保存9字节的” Tutorial”，执行sdscat之后的SDS</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/349b51770daf44a387a37db972683c38" alt="原来redis是这样存字符串的"></p>
<p>在扩展SDS空间之前，SDS API会先检查未使用空间是否足够，如果足够的话，API就会直接使用未使用空间，而无须执行内存重分配。通过这种预分配策略，SDS将连续增长N次字符串所需的内存重分配次数从必定N次降低为最多N次。</p>
<ul>
<li>惰性空间释放</li>
</ul>
<p>惰性空间释放用于优化SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用。举个例子，如果有个字符串：XYXaYYbcXYY</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/c2fed33f61f643249cd7b8fe119b295f" alt="原来redis是这样存字符串的"></p>
<p>现在要移除XY，SDS移除后如下图：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/e1a735c70efd49abbf7ee29d401764de" alt="原来redis是这样存字符串的"></p>
<p>注意执行sdstrim之后的SDS并没有释放多出来的8字节空间，而是将这8字节空间作为未使用空间保留在了SDS里面，如果将来要对SDS进行增长操作的话，这些未使用空间就可能会派上用场。现在想要对上面的字符串添加“ Redis”,注意Redis前面有个空格。因为SDS里面预留的8字节空间已经足以拼接6个字节长的” Redis”了，所以不需要重新分配内存。</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/162816a36ea346269a96e13099d18717" alt="原来redis是这样存字符串的"></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/19/Redis字符串/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/16/深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-16T23:11:03+08:00">
	
		    2月 16, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="深入详解美团点评CAT跨语言服务监控（一）-CAT简介与部署"><a href="#深入详解美团点评CAT跨语言服务监控（一）-CAT简介与部署" class="headerlink" title="深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署"></a>深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署</h1><p>置顶 2018年07月02日 12:50:45 <a href="https://me.csdn.net/caohao0591" target="_blank" rel="noopener">曹号</a> 阅读数：4676</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">下一篇： CAT跨语言服务链监控（二） CAT服务端初始化</a></p>
<p>前言： CAT是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，除了与点评RPC组件融合的很好之外，他将会能与Spring、MyBatis、Dubbo 等框架以及Log4j 等结合，支持PHP、C++、Go等多语言应用，基本接入了美团点评上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团点评各业务线提供系统的性能指标、健康状况、监控告警等，在微服务监控领域也是非常有用的一套组件。支撑这美团每天450亿的消息，50TB的数据监控，应用于 7000+应用服务器，2000+的业务，单台机器能15W qps，15台CAT物理集群，有着极高的性能，同时CAT支持丰富的报表，架构拥有灵活的扩展性，用户可以定制自己的监控、报表需求，本文将就CAT的部署、架构源码以及多语言支持等方面展开剖析。CAT在携程、陆金所、猎聘网、找钢网、<a href="https://www.baidu.com/s?wd=%E5%B9%B3%E5%AE%89%E9%93%B6%E8%A1%8C&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">平安银行</a>等多家互联网公司生产环境应用。</p>
<p>目录：</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80693289" target="_blank" rel="noopener">（一） CAT简介与部署</a></p>
<p>​    介绍<br>​    背景介绍<br>​    Cat系统的特性<br>​    消息树<br>​    CAT服务端部署<br>​    CAT客户端Demo</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">（二） CAT服务端初始化</a><br>    Cat模块<br>    Cat-servlet初始化<br>    plexus - IOC容器<br>    模块的加载 - 模型模式<br>    cat-home的setup<br>    TcpSocketReceiver— netty reactor 模式的应用<br>    消息的解码<br><a href="https://blog.csdn.net/caohao0591/article/details/80207806" target="_blank" rel="noopener">（三） CAT客户端原理</a><br>    cat客户端部分核心类<br>    消息的组织 - 消息树<br>    客户端的初始化<br>    消息生产 – 入栈<br>    Context 线程本地变量<br>    Transaction事务的开启<br>    其他类型消息组合<br>    消息的完成-出栈<br>    消息的发送-队列化<br>    消息的序列化<br>    MessageId的设计<br><a href="https://blog.csdn.net/caohao0591/article/details/80200769" target="_blank" rel="noopener">（四） 服务端消息分发</a><br>    分发架构<br>    分析管理器的初始化<br>    消费者与周期管理器的初始化<br>    什么是周期？<br>    周期任务-任务队列<br>    消息分发<br>    周期策略<br><a href="https://blog.csdn.net/caohao0591/article/details/80293833" target="_blank" rel="noopener">（五） 配置与数据库操作</a><br>    CAT配置<br>    代码自动生成<br>    数据库操作<br>    数据库连接管理<br><a href="https://blog.csdn.net/caohao0591/article/details/80231519" target="_blank" rel="noopener">（六） 消息分析器与报表(一)</a><br>    消息分析器的构建<br>    TopAnalyzer<br>    EventAnalyzer - 事件发生次数分析<br>    MetricAnalyzer - 业务分析<br>    ProblemAnalyzer -异常分析<br>    TransactionAnalyzer - 事务分析<br><a href="https://blog.csdn.net/caohao0591/article/details/80448847" target="_blank" rel="noopener">（七）消息分析器与报表(二)</a><br>    CrossAnalyzer-调用链分析<br>    StorageAnalyzer  –数据库/缓存分析<br>    StateAnalyzer – CAT状态分析<br>    HeartbeatAnalyzer  – 心跳分析<br>    DumpAnalyzer – 原始消息LogView存储<br>    自定义分析器与报表<br><a href="https://blog.csdn.net/caohao0591/article/details/80558779" target="_blank" rel="noopener">（八） 报表持久化</a><br>    周期结束<br>    分析器的结束 – 报表持久化<br>    报表预处理<br>    报表的文件存储 – 重入锁<br>    报表的数据库存储<br>    定时任务<br><a href="https://blog.csdn.net/caohao0591/article/details/80691252" target="_blank" rel="noopener">（九） 管理平台MVC框架</a><br>    Servlet容器与请求生命周期<br>    页面路由初始化<br>    请求处理流程<br>（十）与JAVA框架的集成<br>    与Spring MVC集成<br>    与Spring Boot 集成<br>    与Spring Cloud 集成<br>    与dubbo集成<br>    与MyBatis集成<br>    与Log4j集成<br>（十一） 其他语言支持<br>    PHP语言<br>    C++语言<br>    LUA语言<br>    Go语言<br>    Python语言<br>    Node.js语言<br>    Android埋点</p>
<p>​     Object  C – IOS 埋点</p>
<p> （十二） 报警与监控提醒</p>
<p>​    短信通知</p>
<p>​    邮件通知</p>
<p>（十三） CAT与实时计算<br>    hadoop模块</p>
<p>​    spark实时计算模块</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><a href="https://www.oschina.net/p/cat-dianping" target="_blank" rel="noopener">        大众点评CAT</a>系统原型和理念来源于eBay的CAL的系统，CAT系统第一代设计者吴其敏在eBay工作长达十几年，对CAL系统有深刻的理解。CAT不仅增强了CAL系统核心模型，还添加了更丰富的报表。自2014年开源以来，CAT在携程、陆金所、猎聘网、找钢网等多家互联网公司生产环境应用。</p>
<p>​    CAT是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，除了与点评RPC组件融合的很好之外，他将会能与Spring、MyBatis、Dubbo 等框架以及Log4j 等结合，不久将会支持PHP、C++、Go等多语言应用，基本接入了美团点评上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团点评各业务线提供系统的性能指标、健康状况、监控告警等，在微服务监控领域也是非常有用的一套组件。</p>
<p>​    在详细了解CAT的整体设计细节之后，我们可以在CAT基础之上轻松扩展我们自己的监控和数据收集模块。</p>
<p>​    CAT项目的开源地址： <a href="https://github.com/dianping/cat" target="_blank" rel="noopener">https://github.com/dianping/cat</a></p>
<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a><strong>背景介绍</strong></h1><p>​    CAT整个产品研发是从2011年底开始的，当时正是大众点评App Net迁移Java的核心起步阶段。当初大众点评App已经有核心的基础中间件、RPC组件Pigeon、统一配置组件lion。整体Java迁移已经在服务化的路上。随着服务化的深入，整体Java在线上部署规模逐渐变多，同时，暴露的问题也越来越多。典型的问题有：</p>
<ul>
<li>大量报错，特别是核心服务，需要花很久时间才能定位。</li>
<li>异常日志都需要线上权限登陆线上机器排查，排错时间长。</li>
<li>有些简单的错误定位都非常困难（一次将线上的库配置到了Beta，花了整个通宵排错）。</li>
<li>很多<a href="https://www.baidu.com/s?wd=%E4%B8%8D%E4%BA%86%E4%BA%86%E4%B9%8B&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">不了了之</a>的问题都怀疑是网络问题（从现在看，内网真的很少出问题）。</li>
</ul>
<p>​    虽然那时候也有一些简单的监控工具（比如Zabbix，自己研发的Hawk系统等），可能单个工具在某方面的功能还不错，但整体服务化水平<a href="https://www.baidu.com/s?wd=%E5%8F%82%E5%B7%AE%E4%B8%8D%E9%BD%90&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">参差不齐</a>、扩展能力相对较弱，监控工具间不能互通互联，使得查找问题根源基本都需要在多个系统之间切换，有时候真的是靠“人品”才能找出根源。适逢吴其敏从eBay加入大众点评成为首席架构师，eBay的CAL系统在内部非常成功，就在这样天时地利与人和的情况下，我们开始研发了大众点评App第一代监控系统——CAT。</p>
<h1 id="Cat系统的特性"><a href="#Cat系统的特性" class="headerlink" title="Cat系统的特性"></a>Cat系统的特性</h1><ul>
<li>实时处理：信息的价值会随时间锐减，尤其是事故处理过程中。</li>
<li>全量数据：最开始的设计目标就是全量采集，全量的好处有很多。</li>
<li>高可用：所有应用都倒下了，需要监控还站着，并告诉工程师发生了什么，做到故障还原和问题定位。</li>
<li>故障容忍：CAT本身故障不应该影响业务正常运转，CAT挂了，应用不该受影响，只是监控能力暂时减弱。</li>
<li>高吞吐：要想还原真相，需要全方位地监控和度量，必须要有超强的处理吞吐能力。</li>
<li><p>可扩展：支持分布式、跨IDC部署，横向扩展的监控系统。</p>
</li>
<li><p>不保证可靠：允许消息丢失，这是一个很重要的trade-off，目前CAT服务端可以做到4个9的可靠性，可靠系统和不可靠性系统的设计差别非常大。</p>
</li>
</ul>
<p>CAT支持的监控消息类型包括：</p>
<ul>
<li>Transaction 适合记录跨越系统边界的程序访问行为,比如远程调用，数据库调用，也适合执行时间较长的业务逻辑监控，Transaction用来记录一段代码的执行时间和次数。</li>
<li>Event 用来记录一件事发生的次数，比如记录系统异常，它和transaction相比缺少了时间的统计，开销比transaction要小。</li>
<li>Heartbeat 表示程序内定期产生的统计信息, 如CPU%, MEM%, 连接池状态, 系统负载等。</li>
<li>Metric 用于记录业务指标、指标可能包含对一个指标记录次数、记录平均值、记录总和，业务指标最低统计粒度为1分钟。</li>
<li>Trace 用于记录基本的trace信息，类似于log4j的info信息，这些信息仅用于查看一些相关信息</li>
</ul>
<h1 id="消息树"><a href="#消息树" class="headerlink" title="消息树"></a>消息树</h1><p>​    CAT监控系统将每次URL、Service的请求内部执行情况都封装为一个完整的消息树、消息树可能包括Transaction、Event、Heartbeat、Metric和Trace信息，各个消息树之间，通过 rootMessageId以及parentMessageId串联起来，形成整个调用链条。</p>
<p><img src="https://img-blog.csdn.net/20180710092446596" alt="img"></p>
<p><strong>完整的消息树：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710092835555" alt="img"></p>
<p><strong>可视化的消息树：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710092946795" alt="img"></p>
<p><strong>分布式消息树【一台机器调用另外一台机器】：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710093106548" alt="img"></p>
<h1 id="CAT服务端部署"><a href="#CAT服务端部署" class="headerlink" title="CAT服务端部署"></a>CAT服务端部署</h1><p><strong>CAT安装环境：</strong></p>
<ul>
<li><ul>
<li>Linux 2.6以及之上（2.6内核才可以支持epoll），线上服务端部署请使用Linux环境，Mac以及Windows环境可以作为开发环境，美团点评内部CentOS 6.5</li>
<li>Java 6，7，8，服务端推荐是用jdk7的版本，客户端jdk6、7、8都支持</li>
<li>Maven 3.3.3</li>
<li>MySQL 5.6，5.7，更高版本MySQL都不建议使用，不清楚兼容性</li>
<li>J2EE容器建议使用tomcat，建议版本7.0.70</li>
<li>Hadoop环境可选，一般建议规模较小的公司直接使用磁盘模式，可以申请CAT服务端，500GB磁盘或者更大磁盘，这个磁盘挂载在/data/目录上</li>
</ul>
</li>
</ul>
<p><strong>目前我司线上环境：</strong></p>
<p>​    Distributor ID: CentOS<br>​    Description: CentOS release 6.5 (Final)<br>​    Release: 6.5<br>​    Codename: Final<br>​    Server version: Apache Tomcat/8.0.30<br>​    Server built:   Dec 1 2015 22:30:46 UTC<br>​    Server number:  8.0.30.0<br>​    OS Name:        Linux<br>​    OS Version:     2.6.32-431.el6.x86_64<br>​    Architecture:   amd64<br>​    JVM Version:    1.8.0_111-b14<br>​    JVM Vendor:     Oracle Corporation<br>​    Maven 3.3.3<br>​    Mysql 5.6<br>​    Tomcat  7.0.70  建议使用此版本</p>
<p>我的开发环境：</p>
<p>​    操作系统： Windows 7<br>​    IDE： Intelij IDEA<br>​    JDK版本：1.8<br>​    Mysql： 5.6<br>​    Maven： 3.3.3<br>​    Server version：Apache Tomcat/8.0.30</p>
<p><strong>安装CAT集群大致步骤</strong></p>
<p>​    初始化Mysql数据库，一套CAT集群部署一个数据库，初始化脚本在script下的Cat.sql<br>​    准备三台CAT服务器，IP比如为10.1.1.1，10.1.1.2，10.1.1.3，下面的例子会以这个IP为例子<br>​    初始化/data/目录，配置几个配置文件/data/appdatas/cat/*.xml 几个配置文件，具体下面有详细说明<br>​    打包cat.war 放入tomcat容器</p>
<p>​    修改一个路由配置，重启tomcat</p>
<p><strong>Tomcat启动参数调整，修改 catalina.sh文件【服务端】</strong></p>
<p>​    需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署<br>​    建议使用cms gc策略<br>​    建议cat的使用堆大小至少10G以上，开发环境启动2G堆启动即可</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CATALINA_OPTS=<span class="string">"$CATALINA_OPTS -server -Djava.awt.headless=true -Xms25G -Xmx25G -XX:PermSize=256m -XX:MaxPermSize=256m -XX:NewSize=10144m -XX:MaxNewSize=10144m -XX:SurvivorRatio=10 -XX:+UseParNewGC -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=13 -XX:+UseConcMarkSweepGC -XX:+DisableExplicitGC -XX:+UseCMSInitiatingOccupancyOnly -XX:+ScavengeBeforeFullGC -XX:+UseCMSCompactAtFullCollection -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:SoftRefLRUPolicyMSPerMB=0 -XX:-ReduceInitialCardMarks -XX:+CMSPermGenSweepingEnabled -XX:CMSInitiatingPermOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrent -Djava.nio.channels.spi.SelectorProvider=sun.nio.ch.EPollSelectorProvider -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file="</span>%CATALINA_HOME%\conf\logging.properties<span class="string">" -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -Xloggc:/data/applogs/heap_trace.txt -XX:-HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/applogs/HeapDumpOnOutOfMemoryError -Djava.util.Arrays.useLegacyMergeSort=true"</span></span><br></pre></td></tr></table></figure>
<p>​    修改中文乱码 tomcat conf 目录下 server.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">URIEncoding</span>=<span class="string">"utf-8"</span>    <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span>  增加  URIEncoding="utf-8"</span><br></pre></td></tr></table></figure>
<h3 id="程序对于-data-目录具体读写权限【包括客户端-amp-服务端】"><a href="#程序对于-data-目录具体读写权限【包括客户端-amp-服务端】" class="headerlink" title="程序对于/data/目录具体读写权限【包括客户端&amp;服务端】"></a>程序对于/data/目录具体读写权限【包括客户端&amp;服务端】</h3><ul>
<li>注意无论是CAT客户端和服务端都要求/data/目录能进行读写操作，如果/data/目录不能写，建议使用linux的软链接链接到一个固定可写的目录，软链接的基本命令请自行搜索google</li>
<li>此目录会存一些CAT必要的配置文件，运行时候的缓存文件，建议不要修改，如果想改，请自行研究好源码里面的东西，在酌情修改，此目录不支持进行配置化</li>
<li>mkdir /data</li>
<li>chmod 777 /data/ -R</li>
<li>如果是Windows开发环境则是对程序运行盘下的/data/appdatas/cat和/data/applogs/cat有读写权限,如果cat服务运行在e盘的tomcat中，则需要对e:/data/appdatas/cat和e:/data/applogs/cat有读写权限</li>
<li>如果windows实在不知道哪个盘，就所有盘都建好，最后看哪个盘多文件，就知道哪个了，当然你也可以通过配置系统环境变量CAT_HOME来指定服务器日志存储的路径，不过好像数据库连接xml信息等好像不太好自己配置，最好还是采用系统默认的 /data 目录。</li>
</ul>
<h3 id="配置-data-appdatas-cat-client-xml【包括客户端-amp-服务端】"><a href="#配置-data-appdatas-cat-client-xml【包括客户端-amp-服务端】" class="headerlink" title="配置/data/appdatas/cat/client.xml【包括客户端&amp;服务端】"></a>配置/data/appdatas/cat/client.xml【包括客户端&amp;服务端】</h3><ul>
<li>此配置文件的作用是所有的客户端都需要一个地址指向CAT的服务端，比如CAT服务端有三个IP，10.1.1.1，10.1.1.2，10.1.1.3，2280是默认的CAT服务端接受数据的端口，不允许修改，http-port是Tomcat启动的端口，默认是8080，建议使用默认端口。</li>
<li>此文件可以通过运维统一进行部署和维护，比如使用puppert等运维工具。</li>
<li>不同环境这份文件不一样，比如区分prod环境以及test环境，在美团点评内部一共是2套环境的CAT，一份是生产环境，一份是测试环境</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.1"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.2"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.3"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="安装CAT的数据库"><a href="#安装CAT的数据库" class="headerlink" title="安装CAT的数据库"></a>安装CAT的数据库</h3><ul>
<li>数据库的脚本文件 script/Cat.sql</li>
<li>MySQL的一个系统参数：max_allowed_packet，其默认值为1048576(1M)，修改为1000M，修改完需要重启mysql</li>
<li>注意：一套独立的CAT集群只需要一个数据库（之前碰到过个别同学在每台cat的服务端节点都安装了一个数据库）</li>
</ul>
<h3 id="配置-data-appdatas-cat-datasources-xml【服务端配置】"><a href="#配置-data-appdatas-cat-datasources-xml【服务端配置】" class="headerlink" title="配置/data/appdatas/cat/datasources.xml【服务端配置】"></a>配置/data/appdatas/cat/datasources.xml【服务端配置】</h3><p>需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署</p>
<p>注意：此xml仅仅为模板，请根据自己实际的情况替换jdbc.url,jdbc.user,jdbc.password的实际值。 app数据库和cat数据配置为一样，app库不起作用，为了运行时候代码不报错。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">data-sources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"cat"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>1s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[$&#123;jdbc.url&#125;]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">user</span>&gt;</span>$&#123;jdbc.user&#125;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;jdbc.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>1s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[$&#123;jdbc.url&#125;]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">user</span>&gt;</span>$&#123;jdbc.user&#125;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;jdbc.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data-sources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>配置/data/appdatas/cat/server.xml【服务端配置】</strong><br>    需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署<br>    CAT节点一共有四个职责</p>
<p>​    控制台 - 提供给业务人员进行数据查看【默认所有的cat节点都可以作为控制台，不可配置】<br>​    消费机 - 实时接收业务数据，实时处理，提供实时分析报表【默认所有的cat节点都可以作为消费机，不可配置】<br>​    告警端 - 启动告警线程，进行规则匹配，发送告警（目前仅支持单点部署）【可以配置】<br>​    任务机 - 做一些离线的任务，合并天、周、月等报表 【可以配置】<br>​    线上做多集群部署，比如说10.1.1.1，10.1.1.2，10.1.1.3这三台机器</p>
<pre><code>建议选取一台10.1.1.1 负责角色有控制台、告警端、任务机，建议配置域名访问CAT，就配置一台机器10.1.1.1一台机器挂在域名下面
10.1.1.2，10.1.1.3 负责消费机处理，这样能做到有效隔离，任务机、告警等问题不影响实时数据处理
默认script下的server.xml为
</code></pre><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>127.0.0.1:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置说明：</p>
<ul>
<li>local-mode : 建议在开发环境以及生产环境时，都设置为false</li>
<li>hdfs-machine : 定义是否启用HDFS存储方式，默认为 false</li>
<li>job-machine : 定义当前服务是否为报告工作机（开启生成汇总报告和统计报告的任务，只需要一台服务机开启此功能），默认为 false</li>
<li>alert-machine : 定义当前服务是否为报警机（开启各类报警监听，只需要一台服务机开启此功能），默认为 false；</li>
<li>storage : 定义数据存储配置信息</li>
<li>local-report-storage-time : 定义本地报告文件存放时长，单位为（天）</li>
<li>local-logivew-storage-time : 定义本地日志文件存放时长，单位为（天）</li>
<li>local-base-dir : 定义本地数据存储目录，建议直接使用/data/appdatas/cat/bucket目录</li>
<li>hdfs : 定义HDFS配置信息</li>
<li>server-uri : 定义HDFS服务地址</li>
<li>console : 定义服务控制台信息</li>
<li>remote-servers : 定义HTTP服务列表，（远程监听端同步更新服务端信息即取此值）</li>
<li>ldap : 定义LDAP配置信息（这个可以忽略）</li>
<li>ldapUrl : 定义LDAP服务地址（这个可以忽略）</li>
</ul>
<p>按照如上的说明，10.1.1.1 机器/data/appdatas/cat/serverm.xml配置，注意hdfs配置就随便下了一个，请忽略</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>10.1.1.2，10.1.1.3 机器/data/appdatas/cat/serverm.xml配置如下，仅仅job-machine&amp;alert-machine修改为false</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"false"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="war打包"><a href="#war打包" class="headerlink" title="war打包"></a>war打包</h3><p>​    1、在cat的源码目录，执行mvn clean install -DskipTests<br>​    2、如果发现cat的war打包不通过，CAT所需要依赖jar都部署在 <a href="http://unidal.org/nexus/" target="_blank" rel="noopener">http://unidal.org/nexus/</a><br>​    3、可以配置这个公有云的仓库地址到本地的settings路径，理论上不需要配置即可，可以参考cat的pom.xml配置</p>
<p> 4、如果自行打包仍然问题，请使用下面链接进行下载<a href="http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/2.0.0/cat-home-2.0.0.war" target="_blank" rel="noopener">http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/2.0.0/cat-home-2.0.0.war</a></p>
<p>​    5、官方的cat的master版本，重命名为cat.war进行部署，注意此war是用jdk8，服务端请使用jdk8版本<br>​    6、如下是个人本机电脑的测试，下载的jar来自于repo1.maven.org 以及 unidal.org</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/codehaus/plexus/plexus-utils/<span class="number">3.0</span>.<span class="number">24</span>/plexus-utils-<span class="number">3.0</span>.<span class="number">24</span>.jar</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/apache/commons/commons-email/<span class="number">1.1</span>/commons-email-<span class="number">1.1</span>.jar (<span class="number">30</span> KB at <span class="number">9.8</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/javax/servlet/jstl/<span class="number">1.2</span>/jstl-<span class="number">1.2</span>.jar (<span class="number">405</span> KB at <span class="number">107.7</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/com/google/code/javaparser/javaparser/<span class="number">1.0</span>.<span class="number">8</span>/javaparser-<span class="number">1.0</span>.<span class="number">8</span>.jar (<span class="number">235</span> KB at <span class="number">55.4</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/codehaus/plexus/plexus-utils/<span class="number">3.0</span>.<span class="number">24</span>/plexus-utils-<span class="number">3.0</span>.<span class="number">24</span>.jar (<span class="number">242</span> KB at <span class="number">46.9</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/freemarker/freemarker/<span class="number">2.3</span>.<span class="number">9</span>/freemarker-<span class="number">2.3</span>.<span class="number">9</span>.jar (<span class="number">789</span> KB at <span class="number">113.3</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResServer/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResServer-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResTagLibrary/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResTagLibrary-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResTag/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResTag-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResRuntime/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResRuntime-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResApi/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResApi-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResApi/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResApi-<span class="number">1.2</span>.<span class="number">1</span>.jar (<span class="number">21</span> KB at <span class="number">82.7</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResBase/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResBase-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">parent</span> ............................................. <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 40.478 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-client</span> ......................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[03:47 min]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-core</span> ........................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 31.740 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-hadoop</span> ......................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[02:50 min]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-consumer</span> ....................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[  3.197 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-home</span> ........................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 58.964 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">------------------------------------------------------------------------</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">BUILD</span> <span class="selector-tag">SUCCESS</span></span><br><span class="line">```</span><br></pre></td></tr></table></figure>
<h3 id="war部署"><a href="#war部署" class="headerlink" title="war部署"></a>war部署</h3><p>​    1、将cat.war部署到10.1.1.1的tomcat的webapps下，启动tomcat，注意webapps下只允许放一个war，仅仅为cat.war<br>​    2、如果发现重启报错，里面有NPE等特殊情况，可以检查当前java进程，ps aux | grep java，可能存在之前的tomcat的进程没有关闭，又新启动了一个，导致出问题，建议kill -9 干掉所有的java进程<br>​    3、打开控制台的URL，<a href="http://10.1.1.1:8080/cat/s/config?op=routerConfigUpdate" target="_blank" rel="noopener">http://10.1.1.1:8080/cat/s/config?op=routerConfigUpdate</a><br>​    4、注意10.1.1.1这个IP需要替换为自己实际的IP链接，修改路由配置只能修改一次即可</p>
<p>​    5、修改路由配置为如下，当为如下配置时，10.1.1.1 正常不起消费数据的作用，仅当10.1.1.2以及10.1.1.3都挂掉才会进行实时流量消费</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;router-config backup-server=<span class="string">"10.1.1.1"</span> backup-server-port=<span class="string">"2280"</span>&gt;</span><br><span class="line">   &lt;<span class="keyword">default</span>-server id=<span class="string">"10.1.1.2"</span> weight=<span class="string">"1.0"</span> port=<span class="string">"2280"</span> enable=<span class="string">"true"</span>/&gt;</span><br><span class="line">   &lt;<span class="keyword">default</span>-server id=<span class="string">"10.1.1.3"</span> weight=<span class="string">"1.0"</span> port=<span class="string">"2280"</span> enable=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;/router-config&gt;</span><br></pre></td></tr></table></figure>
<p>​    6、重启10.1.1.1的机器的tomcat<br>​    7、将cat.war部署到10.1.1.2，10.1.1.3这两台机器中，启动tomcat<br>​    8、cat集群部署完毕，如果有问题，欢迎在微信群咨询，如果文档有误差，欢迎指正以及提交pullrequest</p>
<p>重启保证数据不丢</p>
<p>​    请在tomcat重启之前调用当前tomcat的存储数据的链接 <a href="http://${ip}:8080/cat/r/home?op=checkpoint，重启之后数据会恢复。【注意重启时间在每小时的整点10-55分钟之间】" target="_blank" rel="noopener">http://${ip}:8080/cat/r/home?op=checkpoint，重启之后数据会恢复。【注意重启时间在每小时的整点10-55分钟之间】</a><br> 线上部署时候，建议把此链接调用存放于tomcat的stop脚本中，这样不需要每次手工调用</p>
<h3 id="开发环境CAT的部署"><a href="#开发环境CAT的部署" class="headerlink" title="开发环境CAT的部署"></a>开发环境CAT的部署</h3><p>​    1、请按照如上部署/data/环境目录，数据库配置client.xml ,datasources.xml,server.xml这三个配置文件，注意server.xml里面的节点角色，job-machine&amp;alert-machine都可以配置为true<br>​    2、在cat目录中执行 mvn eclipse:eclipse，此步骤会生成一些代码文件，直接导入到工程会发现找不到类<br>​    3、将源码以普通项目到入eclipse中，注意不要以maven项目导入工程<br>​    4、运行com.dianping.cat.TestServer 这个类，即可启动cat服务器<br>​    5、这里和集群版本唯一区别就是服务端部署单节点，client.xml server.xml以及路由地址配置为单台即可</p>
<h1 id="CAT客户端Demo"><a href="#CAT客户端Demo" class="headerlink" title="CAT客户端Demo"></a>CAT客户端Demo</h1><p>   <strong>cat客户端的配置：</strong></p>
<p>​    cat客户端也需要配置 /data 目录，程序对于/data/目录具体读写权限可以参考上一节，</p>
<p>​    然后通过maven引入cat客户端包，在pom.xml 加入：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​    引入之后：</p>
<p><img src="https://img-blog.csdn.net/20180710112822532" alt="img"></p>
<p>​    以上配置会通过maven从网上引入 cat-core和cat-client 包，如果无法配置引入，也可以手动引入 cat-client.jar 包。</p>
<p>​    CAT默认会将/data/appdatas/cat 作为CAT Home目录，这个目录至关重要，CAT客户端配置文件 client.xml 是在这个目录内，当然，如果你是在 windows 下调试， 你也可以在src/main/resources/ 目录下新建 META-INF/cat 目录， 并将 client.xml 配置文件放入 src/main/resources/META-INF/cat 目录里，你可以为你的监控配置domain，即项目名，如下配置 <domain id="translate"> 。</domain></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"config.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">"translate"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Local mode for development --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"127.0.0.1"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- If under production environment, put actual server address as list. --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            &lt;server ip="192.168.7.71" port="2280" /&gt; </span></span><br><span class="line"><span class="comment">            &lt;server ip="192.168.7.72" port="2280" /&gt; </span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>第一个监控程序：</strong></p>
<p>​    所有都配置好了，接下来我们来写第一个监控程序，监控都是由用户自己埋点，当然，在本书最后，我们将会讲解CAT监控如何与各个流行框架之间更好的融合，以帮助用户达到无侵入式的监控埋点，假设我们对用户提供了一个翻译服务，其中有个接口就是HelloWorld，在下面程序中，我们将以事务日志形式记录用户调用行为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">helloWorld</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    MessageProducer cat = Cat.getProducer();</span><br><span class="line">    Transaction t = cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"Translate/HelloWorld"</span>);  <span class="comment">//type=URL的事务记录: 你的接口/方法名称</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//do your business</span></span><br><span class="line">        t.setStatus(Message.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Cat.getProducer().logError(e);</span><br><span class="line">        t.setStatus(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        t.complete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    好了，我们再去管理平台去看看报表信息把，Transaction事务报表中，type=URL的事务有3条，我们通常用URL类型的事务消息标志着接口服务的开始，展开之后，我们看到这个里面该项目提供的3个服务被调用了，其中就有我们的 Translate/HelloWorld：</p>
<p><img src="https://img-blog.csdn.net/20180710115701626" alt="img"></p>
<p><img src="https://img-blog.csdn.net/20180710115840344" alt="img"></p>
<p>再点开某个接口的[::show::]进入详细统计，包括耗时分布、每分钟的数据、以及该服务集群下各个机器的统计情况，我们可以通过这个看出是不是某台机器出了问题：</p>
<p><img src="https://img-blog.csdn.net/20180712105601499" alt="img"></p>
<p>点击LogView进入最近一条事务的原始日志（problem报表才会记录全部的原始日志）：</p>
<p><img src="https://img-blog.csdn.net/20180710120047134" alt="img"></p>
<p>​    接下来，我们来看一个更复杂的案例，涉及服务的调用以及数据库、缓存的调用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Translate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; maps = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    <span class="keyword">public</span> Cat.Context context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/translate/getWordMean"</span>, produces = <span class="string">"application/json"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="comment">//获取翻译释义</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getWordMean</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        context = <span class="keyword">new</span> Cat.Context() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProperty</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">                maps.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> maps.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;; <span class="comment">//服务调用消息上下文</span></span><br><span class="line"></span><br><span class="line">        MessageProducer cat = Cat.getProducer();</span><br><span class="line">        Transaction t = cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"translate/getWordMean"</span>);  <span class="comment">//你的接口/方法名称</span></span><br><span class="line">        cat.logEvent(<span class="string">"ClientInfo"</span>, <span class="string">"RemoteIp=127.0.0.1&amp;Referer=..."</span>);  <span class="comment">//记录远程调用端信息</span></span><br><span class="line">        cat.logEvent(<span class="string">"Payload"</span>, <span class="string">"HTTP/GET /translate/getWordMean?client=3&amp;clientVersion=0&amp;v=9.5&amp;uid=3214567...."</span>); <span class="comment">//调用端参数</span></span><br><span class="line">        <span class="comment">//用户校验</span></span><br><span class="line">        authCheck();</span><br><span class="line">        <span class="comment">//先从缓存Redis获取结果</span></span><br><span class="line">        Transaction cacheT = cat.newTransaction(<span class="string">"Cache.memcached.redis"</span>, <span class="string">"translate_result:get"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"Cache.memcached.redis.server"</span>, <span class="string">"127.0.0.1:6379"</span>);</span><br><span class="line">        <span class="comment">//do your cache operation</span></span><br><span class="line">        cacheT.setStatus(Message.SUCCESS);</span><br><span class="line">        cacheT.complete();</span><br><span class="line">        <span class="comment">//do your translate operation</span></span><br><span class="line">        <span class="comment">//记录远程语音服务调用</span></span><br><span class="line">        Transaction callT = cat.newTransaction(<span class="string">"Call"</span>, <span class="string">"voice:getVoice"</span>);</span><br><span class="line">        Cat.logEvent(<span class="string">"Call.server"</span>,<span class="string">"localhost"</span>);  <span class="comment">//远程服务地址</span></span><br><span class="line">        Cat.logEvent(<span class="string">"Call.app"</span>,<span class="string">"voice"</span>);   <span class="comment">//语音服务</span></span><br><span class="line">        Cat.logEvent(<span class="string">"Call.port"</span>,<span class="string">"8080"</span>);   <span class="comment">//语音服务端口</span></span><br><span class="line">        Cat.logRemoteCallClient(context); <span class="comment">//生成消息调用上下文，主要是几个messageId的创建。</span></span><br><span class="line"></span><br><span class="line">        voiceService(context); </span><br><span class="line">        callT.setStatus(Message.SUCCESS);</span><br><span class="line">        callT.complete();</span><br><span class="line">        OutputData result = <span class="keyword">new</span> OutputData();</span><br><span class="line">        result.setErrno(<span class="number">0</span>);</span><br><span class="line">        result.setErrmsg(<span class="string">"success"</span>);</span><br><span class="line">        result.setTranslateResult(<span class="string">"translate result ..."</span>);</span><br><span class="line"></span><br><span class="line">        t.setStatus(Message.SUCCESS);</span><br><span class="line">        t.complete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">authCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MessageProducer cat = Cat.getProducer();</span><br><span class="line">        Transaction checkUser = cat.newTransaction(<span class="string">"Method"</span>, <span class="string">"checkAuth"</span>);</span><br><span class="line">        <span class="comment">//从数据库查询用户信息</span></span><br><span class="line">        Transaction sqlT = cat.newTransaction(<span class="string">"SQL"</span>, <span class="string">"Select"</span>);</span><br><span class="line"></span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Database"</span>, <span class="string">"jdbc:mysql://127.0.0.1:3306/user"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Method"</span>, <span class="string">"select"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Statement"</span>, <span class="string">"SELECT"</span>, Message.SUCCESS, <span class="string">"select * from user_info"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//to do your SQL query</span></span><br><span class="line">        sqlT.setStatus(Message.SUCCESS);</span><br><span class="line">        sqlT.complete();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//to do your auth check</span></span><br><span class="line">        checkUser.setStatus(Message.SUCCESS);</span><br><span class="line">        checkUser.complete();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//线程模拟语音服务</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">voiceService</span><span class="params">(<span class="keyword">final</span> Cat.Context context)</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//服务器埋点，Domain为 voice 提供语音服务</span></span><br><span class="line">                Cat.getManager().getThreadLocalMessageTree().setDomain(<span class="string">"voice"</span>);</span><br><span class="line">                MessageProducer cat = Cat.getProducer();</span><br><span class="line">                Transaction voiceService = Cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"voice/getVoice"</span>); <span class="comment">//你的接口/方法名称</span></span><br><span class="line">                cat.logEvent(<span class="string">"ClientInfo"</span>, <span class="string">"RemoteIp=127.0.0.1&amp;Referer=..."</span>);  <span class="comment">//记录远程调用端信息</span></span><br><span class="line">                cat.logEvent(<span class="string">"Payload"</span>, <span class="string">"HTTP/GET /voice/getVoice?client=3&amp;clientVersion=0&amp;v=9.5&amp;uid=3214567...."</span>); <span class="comment">//调用端参数</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//记录服务信息</span></span><br><span class="line">                Transaction child = Cat.newTransaction(<span class="string">"Service"</span>, <span class="string">"voice:getVoice"</span>);</span><br><span class="line">                Cat.logEvent(<span class="string">"Service.client"</span>, <span class="string">"localhost"</span>); <span class="comment">//客户端地址</span></span><br><span class="line">                Cat.logEvent(<span class="string">"Service.app"</span>, <span class="string">"translate"</span>); <span class="comment">//客户端domain</span></span><br><span class="line">                Cat.logRemoteCallServer(context); <span class="comment">//记录消息上下文</span></span><br><span class="line">                <span class="comment">//to do your business</span></span><br><span class="line">                child.setStatus(Message.SUCCESS);</span><br><span class="line">                child.complete();</span><br><span class="line">                voiceService.setStatus(Message.SUCCESS);</span><br><span class="line">                voiceService.complete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">        <span class="comment">// wait for it to complete</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// ignore it</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    这是我们一个对外提供的翻译服务，getWordMean为服务控制器入口，我们将原始消息展开如下，整个服务处理耗时571ms，一进来我们会记录URL类型事务，以及调用参数，然后记录用户校验函数，在函数内部，有查询用户信息的数据库操作，也会被记录下，查询耗时150ms，接下来我们会先从缓存获取结果， 缓存查询耗时 59ms，随后我们翻译内容，翻译之后我们会调用语音服务提供的发音接口，voice/getVoice，发音接口调用一共耗时 361 ms。</p>
<p><img src="https://img-blog.csdn.net/20180710170905183" alt="img"></p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">下一篇：   CAT跨语言服务链监控（二） CAT服务端初始化</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/16/深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/12/Vue/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-12T18:47:58+08:00">
	
		    2月 12, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h1><p>Vue官网：<a href="https://cn.vuejs.org/" target="_blank" rel="noopener">https://cn.vuejs.org/</a></p>
<p>脚手架：<a href="https://cli.vuejs.org/zh/" target="_blank" rel="noopener">https://cli.vuejs.org/zh/</a></p>
<p>路由：<a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener">https://router.vuejs.org/zh/</a></p>
<p>Vue菜鸟教程：<a href="http://www.runoob.com/vue2/vue-tutorial.html" target="_blank" rel="noopener">http://www.runoob.com/vue2/vue-tutorial.html</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/12/Vue/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Xiangjy. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/dx.png" alt="作者的图片">
        
            <h4 id="about-card-name">Xiangjy</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END--><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



    </body>
</html>
