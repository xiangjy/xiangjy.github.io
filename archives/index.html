
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Xiangjy&#39;s Blog">
    <title>归档 - Xiangjy&#39;s Blog</title>
    <meta name="author" content="Xiangjy">
    
    
        <link rel="icon" href="http://localhost:4000/assets/images/dx.png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Xiangjy&#39;s Blog">
<meta property="og:url" content="http://localhost:4000/archives/index.html">
<meta property="og:site_name" content="Xiangjy&#39;s Blog">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xiangjy&#39;s Blog">
    
    
        
    
    
        <meta property="og:image" content="http://localhost:4000/assets/images/dx.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

    
</head>

    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Xiangjy&#39;s Blog</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/dx.png" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/dx.png" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Xiangjy</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="#search" title="搜索">
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="http://stackoverflow.com/users" target="_blank" rel="noopener" title="Stack Overflow">
                    
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://twitter.com/" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://facebook.com/" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://plus.google.com/" target="_blank" rel="noopener" title="Google Plus">
                    
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Plus</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.linkedin.com/profile/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/mailto" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/04/12/Nginx/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-12T09:54:52+08:00">
	
		    4月 12, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h3 id="我眼中的-Nginx（一）：Nginx-和位运算"><a href="#我眼中的-Nginx（一）：Nginx-和位运算" class="headerlink" title="我眼中的 Nginx（一）：Nginx 和位运算"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOgyAURE8jSwJ-EFywsFrvgYhCi9ZYTGtP399VM5PJyywmMxrJdUWiKRmvmUABB6Yop50WZdeqq2ZN0_G2LwRbbEz02M5jpe6xkGA8SA-2ckMN4BwMk9AWpJosgHKjZmQxNXCukZIJOW_PApqi7NHZu_DfwsLuObrkkUBpTE5DXhLZzS2u82nXmb4jJt74BI9NpL8Jks2xXeLL-3s6ZT2uX-dyP1c" target="_blank" rel="noopener"><strong>我眼中的 Nginx（一）：Nginx 和位运算</strong></a></h3><p>众所周知 Nginx 以性能而出名，这和它优秀的代码实现有着密切的关系，而本文所要讲述的——位运算，也是促成 Nginx 优秀性能的原因之一。</p>
<p><strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（二）：HTTP-2-dynamic-table-size-update"><a href="#我眼中的-Nginx（二）：HTTP-2-dynamic-table-size-update" class="headerlink" title="我眼中的 Nginx（二）：HTTP/2 dynamic table size update"></a><a href="http://email.mail.upyun.com/c/eJxFjsEOgjAQRL-GHptd2sJy6AFB_wPLYqsFiZYofr31ZGYymczhZUZrkCoRbAnYgM5SqKCWKHvSZd_VR4K27bE7FRrmIUS5rfu2SHefhbc01eC0NiNPFQCPzhimqjR0npgn48RsG4VIBCJan9L6LFRblKfsxM7_WXkYHim4yLkpwpwofZqjeNhrWC77sFzkO-TMNz6e8xLkDyGS3dZDeDHf4m6acfkC_40_kw" target="_blank" rel="noopener"><strong>我眼中的 Nginx（二）：HTTP/2 dynamic table size update</strong></a></h3><p>HTTP/2 使用了 HPACK 来压缩头部，通过使用索引替代原始的文本来减少传输的字节数。</p>
<p><strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（三）：Nginx-变量和变量插值"><a href="#我眼中的-Nginx（三）：Nginx-变量和变量插值" class="headerlink" title="我眼中的 Nginx（三）：Nginx 变量和变量插值"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOwiAURE9TloTfD_azYFFbvQcCCkprozRaTy-uzEwmk1m8jDcKaMeSaQVoIasQUHQc-EiyHYfuQKLvRxiOjRSTTZmvy7bO3N0nFo2SSA6URrK-E-LspNeddSdUOzifyLPJaAQgEiybWMrybLBv2mN1CS7-WXWwj5JcDrUhYU3gsUyZPcw1zZfNzhf-TjXrjU8MdUn8h2DFrMs-vUK45U1pP38BrkU--g" target="_blank" rel="noopener"><strong>我眼中的 Nginx（三）：Nginx 变量和变量插值</strong></a></h3><p>Nginx 允许我们在配置文件里嵌入”变量”，这些变量由 Nginx 的各个模块定义，其目的是为了提升配置的灵活性。<strong>了解详情</strong></p>
<h3 id="我眼中的-Nginx（四）：是什么让你的-Nginx-服务退出这么慢？"><a href="#我眼中的-Nginx（四）：是什么让你的-Nginx-服务退出这么慢？" class="headerlink" title="我眼中的 Nginx（四）：是什么让你的 Nginx 服务退出这么慢？"></a><a href="http://email.mail.upyun.com/c/eJxFjkEOgyAURE8jS8L3g-KChdV6DxRaaNEai2nt6fu7amYymbzFZJxRoCsWTSmgEZKEgKLmwHsty76rz1q0bQ_dUEgx25j4vh77wqfHzILxQqKqnZ5GqawWmiwvHgBHiVg5z2bTIABxlkzIeX0W2BblQM5-Cv8tAnbLcUqeGmpFCTzkObHN3OJyPexy5e9ISTc-wROJ_DfBstnXU3x5f0-HatzyBYFzPpc" target="_blank" rel="noopener"><strong>我眼中的 Nginx（四）：是什么让你的 Nginx 服务退出这么慢？</strong></a></h3><p>本文将介绍 Nginx worker 进程退出时的准备步骤，延缓退出的原因，并介绍对应的解决办法。</p>
<p><strong>了解详情</strong></p>
<p><a href="http://email.mail.upyun.com/c/eJxFjk0OwiAUhE9TluQ96A8sWNTW3gMpFRSwqTRaTy-uzEwmk1l8mVk1KFriFQOUUBdx5NBRpKOo2Th0ZwF9P-IwVTVE7QPd12NP1DwiccpotsxNqxfQlqGUwoDsQF6skAta05GoJEcUAkhQLuf1WfG-YlNxtsb9WWXQW_Ym2NK4aEsidTkGsqmbT9dDpyt9-5LlxsfZsnj6Q5Cs9vXkX9bew9HIOX0B75Q_ZQ" target="_blank" rel="noopener"><strong>我眼中的 Nginx（五）：Nginx — 子请求设计之道</strong></a><br>使用子请求机制的意义在于，它能够分散原本集中在单个请求里的处理逻辑，简化任务，大大降低请求的复杂度。<strong>了解详情</strong></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/04/12/Nginx/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/04/08/MySQL/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-08T10:45:33+08:00">
	
		    4月 08, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>###安装mysql</p>
<p>CentOS默认不支持mysql</p>
<p>yum remove mariadb-server<br>cd /var/lib &amp;&amp; rm -rfv mysql<br>yum install mariadb-server</p>
<p>###添加远程访问用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'new_root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'***'</span>;</span><br><span class="line">  <span class="keyword">GRANT</span> ALL <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'new_root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'***'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span> MAX_QUERIES_PER_HOUR <span class="number">0</span> MAX_CONNECTIONS_PER_HOUR <span class="number">0</span> MAX_UPDATES_PER_HOUR <span class="number">0</span> MAX_USER_CONNECTIONS <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
                    
                        

                    
                    
                        <p>
                            <a href="/2019/04/08/MySQL/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/19/Redis字符串/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-19T09:12:53+08:00">
	
		    2月 19, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Redis字符串"><a href="#Redis字符串" class="headerlink" title="Redis字符串"></a>Redis字符串</h1><h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>Redis没有直接使用C语言传统的字符串表示（以空字符结尾的字符数组，以下简称C字符串），而是自己构建了一种名为简单动态字符串（simple dynamic string，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。比如说 “SET name kobe”这个命令，redis将在数据库中创建一个键值对。</p>
<p>键值对的键是一个字符串对象，对象的底层实现是一个保存着字符串“name”的SDS</p>
<p>键值对的值是一个字符串对象，对象的底层实现是一个保存着字符串“kobe”的SDS</p>
<p>下图可以解释SDS的数据结构</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/c76ddab18f05469abbd36156cce071b7" alt="原来redis是这样存字符串的"></p>
<ul>
<li>free属性的值为0，表示这个SDS没有分配任何未使用空间。</li>
<li>len属性的值为5，表示这个SDS保存了一个五字节长的字符串。</li>
<li>buf属性是一个char类型的数组，数组的前五个字节分别保存了’R’、’e’、’d’、’i’、’s’五个字符，而最后一个字节则保存了空字符’’</li>
</ul>
<p>与C字符串相比，SDS具有以下优点：</p>
<h1 id="获取字符串长度的时间复杂度为O-1"><a href="#获取字符串长度的时间复杂度为O-1" class="headerlink" title="获取字符串长度的时间复杂度为O(1)"></a>获取字符串长度的时间复杂度为O(1)</h1><p>C语言使用长度为N+1的字符数组来表示长度为N的字符串，并且字符数组的最后一个元素总是空字符’’。</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/046a00507bac4e0b84d3fbf7c947c631" alt="原来redis是这样存字符串的"></p>
<p>因为C字符串并不记录自身的长度信息，所以为了获取一个C字符串的长度，程序必须遍历整个字符串，对遇到的每个字符进行计数，直到遇到代表字符串结尾的空字符为止，这个操作的复杂度为<strong>O(N)</strong>。和C字符串不同，因为SDS在len属性中记录了SDS本身的长度，所以获取一个SDS长度的复杂度仅为O(1)。</p>
<h1 id="杜绝缓冲区溢出"><a href="#杜绝缓冲区溢出" class="headerlink" title="杜绝缓冲区溢出"></a>杜绝缓冲区溢出</h1><p>举个例子，假设程序里有两个在内存中紧邻着的C字符串s1和s2，其中s1保存了字符串”Redis”，而s2则保存了字符串”MongoDB</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/0c76350300c344e785638e9d00c3cdc6" alt="原来redis是这样存字符串的"></p>
<p>如果一个程序员决定通过执行</p>
<p>strcat(s1, “ Cluster”)</p>
<p>将s1的内容修改为”Redis Cluster”，但粗心的他却忘了在执行strcat之前为s1分配足够的空间，那么在strcat函数执行之后，s1的数据将溢出到s2所在的空间中，导致s2保存的内容被意外地修改。与C字符串不同，SDS的空间分配策略完全杜绝了发生缓冲区溢出的可能性：当SDS API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求，如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小，然后才执行实际的修改操作，所以使用SDS既不需要手动修改SDS的空间大小，也不会出现前面所说的缓冲区溢出问题。</p>
<h1 id="减少修改字符串长度时所需的内存重分配次数"><a href="#减少修改字符串长度时所需的内存重分配次数" class="headerlink" title="减少修改字符串长度时所需的内存重分配次数"></a>减少修改字符串长度时所需的内存重分配次数</h1><ul>
<li>空间预分配</li>
</ul>
<p>空间预分配用于优化SDS的字符串增长操作：当SDS的API对一个SDS进行修改，并且需要对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必须要的空间，还会为SDS分配额外的未使用空间。其中，额外分配的未使用空间数量由以下公式决定：</p>
<p>如果对SDS进行修改之后，SDS的长度（也即是len属性的值）将小于1MB，那么程序分配和len属性同样大小的未使用空间，这时SDS len属性的值将和free属性的值相同。举个例子，如果进行修改之后，SDS的len将变成13字节，那么程序也会分配13字节的未使用空间，SDS的buf数组的实际长度将变成13+13+1=27字节（额外的一字节用于保存空字符）。如果对SDS进行修改之后，SDS的长度将大于等于1MB，那么程序会分配1MB的未使用空间。举个例子，如果进行修改之后，SDS的len将变成30MB，那么程序会分配1MB的未使用空间，SDS的buf数组的实际长度将为30MB+1MB+1byte。举个例子：</p>
<p>如果存在“redis”SDS如下图：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/e667f1a9003143c184125d223b8838ae" alt="原来redis是这样存字符串的"></p>
<p>执行：</p>
<p>strcat(s1, “ Cluster”)</p>
<p>那么sdscat将执行一次内存重分配操作，将SDS的长度修改为13字节，并将SDS的未使用空间同样修改为13字节，如下图所示：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/f9ddf635f4424b32a85e58d25d059ffe" alt="原来redis是这样存字符串的"></p>
<p>如果这时我们再次执行</p>
<p>strcat(s1, “ Tutorial”)</p>
<p>那么这次sdscat将不需要执行内存重分配，因为未使用空间里面的13字节足以保存9字节的” Tutorial”，执行sdscat之后的SDS</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/349b51770daf44a387a37db972683c38" alt="原来redis是这样存字符串的"></p>
<p>在扩展SDS空间之前，SDS API会先检查未使用空间是否足够，如果足够的话，API就会直接使用未使用空间，而无须执行内存重分配。通过这种预分配策略，SDS将连续增长N次字符串所需的内存重分配次数从必定N次降低为最多N次。</p>
<ul>
<li>惰性空间释放</li>
</ul>
<p>惰性空间释放用于优化SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用。举个例子，如果有个字符串：XYXaYYbcXYY</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/c2fed33f61f643249cd7b8fe119b295f" alt="原来redis是这样存字符串的"></p>
<p>现在要移除XY，SDS移除后如下图：</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/e1a735c70efd49abbf7ee29d401764de" alt="原来redis是这样存字符串的"></p>
<p>注意执行sdstrim之后的SDS并没有释放多出来的8字节空间，而是将这8字节空间作为未使用空间保留在了SDS里面，如果将来要对SDS进行增长操作的话，这些未使用空间就可能会派上用场。现在想要对上面的字符串添加“ Redis”,注意Redis前面有个空格。因为SDS里面预留的8字节空间已经足以拼接6个字节长的” Redis”了，所以不需要重新分配内存。</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/162816a36ea346269a96e13099d18717" alt="原来redis是这样存字符串的"></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/19/Redis字符串/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/16/深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-16T23:11:03+08:00">
	
		    2月 16, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="深入详解美团点评CAT跨语言服务监控（一）-CAT简介与部署"><a href="#深入详解美团点评CAT跨语言服务监控（一）-CAT简介与部署" class="headerlink" title="深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署"></a>深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署</h1><p>置顶 2018年07月02日 12:50:45 <a href="https://me.csdn.net/caohao0591" target="_blank" rel="noopener">曹号</a> 阅读数：4676</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">下一篇： CAT跨语言服务链监控（二） CAT服务端初始化</a></p>
<p>前言： CAT是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，除了与点评RPC组件融合的很好之外，他将会能与Spring、MyBatis、Dubbo 等框架以及Log4j 等结合，支持PHP、C++、Go等多语言应用，基本接入了美团点评上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团点评各业务线提供系统的性能指标、健康状况、监控告警等，在微服务监控领域也是非常有用的一套组件。支撑这美团每天450亿的消息，50TB的数据监控，应用于 7000+应用服务器，2000+的业务，单台机器能15W qps，15台CAT物理集群，有着极高的性能，同时CAT支持丰富的报表，架构拥有灵活的扩展性，用户可以定制自己的监控、报表需求，本文将就CAT的部署、架构源码以及多语言支持等方面展开剖析。CAT在携程、陆金所、猎聘网、找钢网、<a href="https://www.baidu.com/s?wd=%E5%B9%B3%E5%AE%89%E9%93%B6%E8%A1%8C&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">平安银行</a>等多家互联网公司生产环境应用。</p>
<p>目录：</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80693289" target="_blank" rel="noopener">（一） CAT简介与部署</a></p>
<p>​    介绍<br>​    背景介绍<br>​    Cat系统的特性<br>​    消息树<br>​    CAT服务端部署<br>​    CAT客户端Demo</p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">（二） CAT服务端初始化</a><br>    Cat模块<br>    Cat-servlet初始化<br>    plexus - IOC容器<br>    模块的加载 - 模型模式<br>    cat-home的setup<br>    TcpSocketReceiver— netty reactor 模式的应用<br>    消息的解码<br><a href="https://blog.csdn.net/caohao0591/article/details/80207806" target="_blank" rel="noopener">（三） CAT客户端原理</a><br>    cat客户端部分核心类<br>    消息的组织 - 消息树<br>    客户端的初始化<br>    消息生产 – 入栈<br>    Context 线程本地变量<br>    Transaction事务的开启<br>    其他类型消息组合<br>    消息的完成-出栈<br>    消息的发送-队列化<br>    消息的序列化<br>    MessageId的设计<br><a href="https://blog.csdn.net/caohao0591/article/details/80200769" target="_blank" rel="noopener">（四） 服务端消息分发</a><br>    分发架构<br>    分析管理器的初始化<br>    消费者与周期管理器的初始化<br>    什么是周期？<br>    周期任务-任务队列<br>    消息分发<br>    周期策略<br><a href="https://blog.csdn.net/caohao0591/article/details/80293833" target="_blank" rel="noopener">（五） 配置与数据库操作</a><br>    CAT配置<br>    代码自动生成<br>    数据库操作<br>    数据库连接管理<br><a href="https://blog.csdn.net/caohao0591/article/details/80231519" target="_blank" rel="noopener">（六） 消息分析器与报表(一)</a><br>    消息分析器的构建<br>    TopAnalyzer<br>    EventAnalyzer - 事件发生次数分析<br>    MetricAnalyzer - 业务分析<br>    ProblemAnalyzer -异常分析<br>    TransactionAnalyzer - 事务分析<br><a href="https://blog.csdn.net/caohao0591/article/details/80448847" target="_blank" rel="noopener">（七）消息分析器与报表(二)</a><br>    CrossAnalyzer-调用链分析<br>    StorageAnalyzer  –数据库/缓存分析<br>    StateAnalyzer – CAT状态分析<br>    HeartbeatAnalyzer  – 心跳分析<br>    DumpAnalyzer – 原始消息LogView存储<br>    自定义分析器与报表<br><a href="https://blog.csdn.net/caohao0591/article/details/80558779" target="_blank" rel="noopener">（八） 报表持久化</a><br>    周期结束<br>    分析器的结束 – 报表持久化<br>    报表预处理<br>    报表的文件存储 – 重入锁<br>    报表的数据库存储<br>    定时任务<br><a href="https://blog.csdn.net/caohao0591/article/details/80691252" target="_blank" rel="noopener">（九） 管理平台MVC框架</a><br>    Servlet容器与请求生命周期<br>    页面路由初始化<br>    请求处理流程<br>（十）与JAVA框架的集成<br>    与Spring MVC集成<br>    与Spring Boot 集成<br>    与Spring Cloud 集成<br>    与dubbo集成<br>    与MyBatis集成<br>    与Log4j集成<br>（十一） 其他语言支持<br>    PHP语言<br>    C++语言<br>    LUA语言<br>    Go语言<br>    Python语言<br>    Node.js语言<br>    Android埋点</p>
<p>​     Object  C – IOS 埋点</p>
<p> （十二） 报警与监控提醒</p>
<p>​    短信通知</p>
<p>​    邮件通知</p>
<p>（十三） CAT与实时计算<br>    hadoop模块</p>
<p>​    spark实时计算模块</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><a href="https://www.oschina.net/p/cat-dianping" target="_blank" rel="noopener">        大众点评CAT</a>系统原型和理念来源于eBay的CAL的系统，CAT系统第一代设计者吴其敏在eBay工作长达十几年，对CAL系统有深刻的理解。CAT不仅增强了CAL系统核心模型，还添加了更丰富的报表。自2014年开源以来，CAT在携程、陆金所、猎聘网、找钢网等多家互联网公司生产环境应用。</p>
<p>​    CAT是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，除了与点评RPC组件融合的很好之外，他将会能与Spring、MyBatis、Dubbo 等框架以及Log4j 等结合，不久将会支持PHP、C++、Go等多语言应用，基本接入了美团点评上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团点评各业务线提供系统的性能指标、健康状况、监控告警等，在微服务监控领域也是非常有用的一套组件。</p>
<p>​    在详细了解CAT的整体设计细节之后，我们可以在CAT基础之上轻松扩展我们自己的监控和数据收集模块。</p>
<p>​    CAT项目的开源地址： <a href="https://github.com/dianping/cat" target="_blank" rel="noopener">https://github.com/dianping/cat</a></p>
<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a><strong>背景介绍</strong></h1><p>​    CAT整个产品研发是从2011年底开始的，当时正是大众点评App Net迁移Java的核心起步阶段。当初大众点评App已经有核心的基础中间件、RPC组件Pigeon、统一配置组件lion。整体Java迁移已经在服务化的路上。随着服务化的深入，整体Java在线上部署规模逐渐变多，同时，暴露的问题也越来越多。典型的问题有：</p>
<ul>
<li>大量报错，特别是核心服务，需要花很久时间才能定位。</li>
<li>异常日志都需要线上权限登陆线上机器排查，排错时间长。</li>
<li>有些简单的错误定位都非常困难（一次将线上的库配置到了Beta，花了整个通宵排错）。</li>
<li>很多<a href="https://www.baidu.com/s?wd=%E4%B8%8D%E4%BA%86%E4%BA%86%E4%B9%8B&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">不了了之</a>的问题都怀疑是网络问题（从现在看，内网真的很少出问题）。</li>
</ul>
<p>​    虽然那时候也有一些简单的监控工具（比如Zabbix，自己研发的Hawk系统等），可能单个工具在某方面的功能还不错，但整体服务化水平<a href="https://www.baidu.com/s?wd=%E5%8F%82%E5%B7%AE%E4%B8%8D%E9%BD%90&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">参差不齐</a>、扩展能力相对较弱，监控工具间不能互通互联，使得查找问题根源基本都需要在多个系统之间切换，有时候真的是靠“人品”才能找出根源。适逢吴其敏从eBay加入大众点评成为首席架构师，eBay的CAL系统在内部非常成功，就在这样天时地利与人和的情况下，我们开始研发了大众点评App第一代监控系统——CAT。</p>
<h1 id="Cat系统的特性"><a href="#Cat系统的特性" class="headerlink" title="Cat系统的特性"></a>Cat系统的特性</h1><ul>
<li>实时处理：信息的价值会随时间锐减，尤其是事故处理过程中。</li>
<li>全量数据：最开始的设计目标就是全量采集，全量的好处有很多。</li>
<li>高可用：所有应用都倒下了，需要监控还站着，并告诉工程师发生了什么，做到故障还原和问题定位。</li>
<li>故障容忍：CAT本身故障不应该影响业务正常运转，CAT挂了，应用不该受影响，只是监控能力暂时减弱。</li>
<li>高吞吐：要想还原真相，需要全方位地监控和度量，必须要有超强的处理吞吐能力。</li>
<li><p>可扩展：支持分布式、跨IDC部署，横向扩展的监控系统。</p>
</li>
<li><p>不保证可靠：允许消息丢失，这是一个很重要的trade-off，目前CAT服务端可以做到4个9的可靠性，可靠系统和不可靠性系统的设计差别非常大。</p>
</li>
</ul>
<p>CAT支持的监控消息类型包括：</p>
<ul>
<li>Transaction 适合记录跨越系统边界的程序访问行为,比如远程调用，数据库调用，也适合执行时间较长的业务逻辑监控，Transaction用来记录一段代码的执行时间和次数。</li>
<li>Event 用来记录一件事发生的次数，比如记录系统异常，它和transaction相比缺少了时间的统计，开销比transaction要小。</li>
<li>Heartbeat 表示程序内定期产生的统计信息, 如CPU%, MEM%, 连接池状态, 系统负载等。</li>
<li>Metric 用于记录业务指标、指标可能包含对一个指标记录次数、记录平均值、记录总和，业务指标最低统计粒度为1分钟。</li>
<li>Trace 用于记录基本的trace信息，类似于log4j的info信息，这些信息仅用于查看一些相关信息</li>
</ul>
<h1 id="消息树"><a href="#消息树" class="headerlink" title="消息树"></a>消息树</h1><p>​    CAT监控系统将每次URL、Service的请求内部执行情况都封装为一个完整的消息树、消息树可能包括Transaction、Event、Heartbeat、Metric和Trace信息，各个消息树之间，通过 rootMessageId以及parentMessageId串联起来，形成整个调用链条。</p>
<p><img src="https://img-blog.csdn.net/20180710092446596" alt="img"></p>
<p><strong>完整的消息树：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710092835555" alt="img"></p>
<p><strong>可视化的消息树：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710092946795" alt="img"></p>
<p><strong>分布式消息树【一台机器调用另外一台机器】：</strong></p>
<p><img src="https://img-blog.csdn.net/20180710093106548" alt="img"></p>
<h1 id="CAT服务端部署"><a href="#CAT服务端部署" class="headerlink" title="CAT服务端部署"></a>CAT服务端部署</h1><p><strong>CAT安装环境：</strong></p>
<ul>
<li><ul>
<li>Linux 2.6以及之上（2.6内核才可以支持epoll），线上服务端部署请使用Linux环境，Mac以及Windows环境可以作为开发环境，美团点评内部CentOS 6.5</li>
<li>Java 6，7，8，服务端推荐是用jdk7的版本，客户端jdk6、7、8都支持</li>
<li>Maven 3.3.3</li>
<li>MySQL 5.6，5.7，更高版本MySQL都不建议使用，不清楚兼容性</li>
<li>J2EE容器建议使用tomcat，建议版本7.0.70</li>
<li>Hadoop环境可选，一般建议规模较小的公司直接使用磁盘模式，可以申请CAT服务端，500GB磁盘或者更大磁盘，这个磁盘挂载在/data/目录上</li>
</ul>
</li>
</ul>
<p><strong>目前我司线上环境：</strong></p>
<p>​    Distributor ID: CentOS<br>​    Description: CentOS release 6.5 (Final)<br>​    Release: 6.5<br>​    Codename: Final<br>​    Server version: Apache Tomcat/8.0.30<br>​    Server built:   Dec 1 2015 22:30:46 UTC<br>​    Server number:  8.0.30.0<br>​    OS Name:        Linux<br>​    OS Version:     2.6.32-431.el6.x86_64<br>​    Architecture:   amd64<br>​    JVM Version:    1.8.0_111-b14<br>​    JVM Vendor:     Oracle Corporation<br>​    Maven 3.3.3<br>​    Mysql 5.6<br>​    Tomcat  7.0.70  建议使用此版本</p>
<p>我的开发环境：</p>
<p>​    操作系统： Windows 7<br>​    IDE： Intelij IDEA<br>​    JDK版本：1.8<br>​    Mysql： 5.6<br>​    Maven： 3.3.3<br>​    Server version：Apache Tomcat/8.0.30</p>
<p><strong>安装CAT集群大致步骤</strong></p>
<p>​    初始化Mysql数据库，一套CAT集群部署一个数据库，初始化脚本在script下的Cat.sql<br>​    准备三台CAT服务器，IP比如为10.1.1.1，10.1.1.2，10.1.1.3，下面的例子会以这个IP为例子<br>​    初始化/data/目录，配置几个配置文件/data/appdatas/cat/*.xml 几个配置文件，具体下面有详细说明<br>​    打包cat.war 放入tomcat容器</p>
<p>​    修改一个路由配置，重启tomcat</p>
<p><strong>Tomcat启动参数调整，修改 catalina.sh文件【服务端】</strong></p>
<p>​    需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署<br>​    建议使用cms gc策略<br>​    建议cat的使用堆大小至少10G以上，开发环境启动2G堆启动即可</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CATALINA_OPTS=<span class="string">"$CATALINA_OPTS -server -Djava.awt.headless=true -Xms25G -Xmx25G -XX:PermSize=256m -XX:MaxPermSize=256m -XX:NewSize=10144m -XX:MaxNewSize=10144m -XX:SurvivorRatio=10 -XX:+UseParNewGC -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=13 -XX:+UseConcMarkSweepGC -XX:+DisableExplicitGC -XX:+UseCMSInitiatingOccupancyOnly -XX:+ScavengeBeforeFullGC -XX:+UseCMSCompactAtFullCollection -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:SoftRefLRUPolicyMSPerMB=0 -XX:-ReduceInitialCardMarks -XX:+CMSPermGenSweepingEnabled -XX:CMSInitiatingPermOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrent -Djava.nio.channels.spi.SelectorProvider=sun.nio.ch.EPollSelectorProvider -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file="</span>%CATALINA_HOME%\conf\logging.properties<span class="string">" -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -Xloggc:/data/applogs/heap_trace.txt -XX:-HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/applogs/HeapDumpOnOutOfMemoryError -Djava.util.Arrays.useLegacyMergeSort=true"</span></span><br></pre></td></tr></table></figure>
<p>​    修改中文乱码 tomcat conf 目录下 server.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">URIEncoding</span>=<span class="string">"utf-8"</span>    <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span>  增加  URIEncoding="utf-8"</span><br></pre></td></tr></table></figure>
<h3 id="程序对于-data-目录具体读写权限【包括客户端-amp-服务端】"><a href="#程序对于-data-目录具体读写权限【包括客户端-amp-服务端】" class="headerlink" title="程序对于/data/目录具体读写权限【包括客户端&amp;服务端】"></a>程序对于/data/目录具体读写权限【包括客户端&amp;服务端】</h3><ul>
<li>注意无论是CAT客户端和服务端都要求/data/目录能进行读写操作，如果/data/目录不能写，建议使用linux的软链接链接到一个固定可写的目录，软链接的基本命令请自行搜索google</li>
<li>此目录会存一些CAT必要的配置文件，运行时候的缓存文件，建议不要修改，如果想改，请自行研究好源码里面的东西，在酌情修改，此目录不支持进行配置化</li>
<li>mkdir /data</li>
<li>chmod 777 /data/ -R</li>
<li>如果是Windows开发环境则是对程序运行盘下的/data/appdatas/cat和/data/applogs/cat有读写权限,如果cat服务运行在e盘的tomcat中，则需要对e:/data/appdatas/cat和e:/data/applogs/cat有读写权限</li>
<li>如果windows实在不知道哪个盘，就所有盘都建好，最后看哪个盘多文件，就知道哪个了，当然你也可以通过配置系统环境变量CAT_HOME来指定服务器日志存储的路径，不过好像数据库连接xml信息等好像不太好自己配置，最好还是采用系统默认的 /data 目录。</li>
</ul>
<h3 id="配置-data-appdatas-cat-client-xml【包括客户端-amp-服务端】"><a href="#配置-data-appdatas-cat-client-xml【包括客户端-amp-服务端】" class="headerlink" title="配置/data/appdatas/cat/client.xml【包括客户端&amp;服务端】"></a>配置/data/appdatas/cat/client.xml【包括客户端&amp;服务端】</h3><ul>
<li>此配置文件的作用是所有的客户端都需要一个地址指向CAT的服务端，比如CAT服务端有三个IP，10.1.1.1，10.1.1.2，10.1.1.3，2280是默认的CAT服务端接受数据的端口，不允许修改，http-port是Tomcat启动的端口，默认是8080，建议使用默认端口。</li>
<li>此文件可以通过运维统一进行部署和维护，比如使用puppert等运维工具。</li>
<li>不同环境这份文件不一样，比如区分prod环境以及test环境，在美团点评内部一共是2套环境的CAT，一份是生产环境，一份是测试环境</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.1"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.2"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"10.1.1.3"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="安装CAT的数据库"><a href="#安装CAT的数据库" class="headerlink" title="安装CAT的数据库"></a>安装CAT的数据库</h3><ul>
<li>数据库的脚本文件 script/Cat.sql</li>
<li>MySQL的一个系统参数：max_allowed_packet，其默认值为1048576(1M)，修改为1000M，修改完需要重启mysql</li>
<li>注意：一套独立的CAT集群只需要一个数据库（之前碰到过个别同学在每台cat的服务端节点都安装了一个数据库）</li>
</ul>
<h3 id="配置-data-appdatas-cat-datasources-xml【服务端配置】"><a href="#配置-data-appdatas-cat-datasources-xml【服务端配置】" class="headerlink" title="配置/data/appdatas/cat/datasources.xml【服务端配置】"></a>配置/data/appdatas/cat/datasources.xml【服务端配置】</h3><p>需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署</p>
<p>注意：此xml仅仅为模板，请根据自己实际的情况替换jdbc.url,jdbc.user,jdbc.password的实际值。 app数据库和cat数据配置为一样，app库不起作用，为了运行时候代码不报错。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">data-sources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"cat"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>1s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[$&#123;jdbc.url&#125;]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">user</span>&gt;</span>$&#123;jdbc.user&#125;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;jdbc.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">data-source</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">maximum-pool-size</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maximum-pool-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">connection-timeout</span>&gt;</span>1s<span class="tag">&lt;/<span class="name">connection-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">idle-timeout</span>&gt;</span>10m<span class="tag">&lt;/<span class="name">idle-timeout</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">statement-cache-size</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">statement-cache-size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">driver</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>&lt;![CDATA[$&#123;jdbc.url&#125;]]&gt;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">user</span>&gt;</span>$&#123;jdbc.user&#125;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;jdbc.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">connectionProperties</span>&gt;</span>&lt;![CDATA[useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;socketTimeout=120000]]&gt;<span class="tag">&lt;/<span class="name">connectionProperties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data-sources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>配置/data/appdatas/cat/server.xml【服务端配置】</strong><br>    需要每台CAT集群10.1.1.1，10.1.1.2，10.1.1.3都进行部署<br>    CAT节点一共有四个职责</p>
<p>​    控制台 - 提供给业务人员进行数据查看【默认所有的cat节点都可以作为控制台，不可配置】<br>​    消费机 - 实时接收业务数据，实时处理，提供实时分析报表【默认所有的cat节点都可以作为消费机，不可配置】<br>​    告警端 - 启动告警线程，进行规则匹配，发送告警（目前仅支持单点部署）【可以配置】<br>​    任务机 - 做一些离线的任务，合并天、周、月等报表 【可以配置】<br>​    线上做多集群部署，比如说10.1.1.1，10.1.1.2，10.1.1.3这三台机器</p>
<pre><code>建议选取一台10.1.1.1 负责角色有控制台、告警端、任务机，建议配置域名访问CAT，就配置一台机器10.1.1.1一台机器挂在域名下面
10.1.1.2，10.1.1.3 负责消费机处理，这样能做到有效隔离，任务机、告警等问题不影响实时数据处理
默认script下的server.xml为
</code></pre><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>127.0.0.1:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置说明：</p>
<ul>
<li>local-mode : 建议在开发环境以及生产环境时，都设置为false</li>
<li>hdfs-machine : 定义是否启用HDFS存储方式，默认为 false</li>
<li>job-machine : 定义当前服务是否为报告工作机（开启生成汇总报告和统计报告的任务，只需要一台服务机开启此功能），默认为 false</li>
<li>alert-machine : 定义当前服务是否为报警机（开启各类报警监听，只需要一台服务机开启此功能），默认为 false；</li>
<li>storage : 定义数据存储配置信息</li>
<li>local-report-storage-time : 定义本地报告文件存放时长，单位为（天）</li>
<li>local-logivew-storage-time : 定义本地日志文件存放时长，单位为（天）</li>
<li>local-base-dir : 定义本地数据存储目录，建议直接使用/data/appdatas/cat/bucket目录</li>
<li>hdfs : 定义HDFS配置信息</li>
<li>server-uri : 定义HDFS服务地址</li>
<li>console : 定义服务控制台信息</li>
<li>remote-servers : 定义HTTP服务列表，（远程监听端同步更新服务端信息即取此值）</li>
<li>ldap : 定义LDAP配置信息（这个可以忽略）</li>
<li>ldapUrl : 定义LDAP服务地址（这个可以忽略）</li>
</ul>
<p>按照如上的说明，10.1.1.1 机器/data/appdatas/cat/serverm.xml配置，注意hdfs配置就随便下了一个，请忽略</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"true"</span> <span class="attr">alert-machine</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>10.1.1.2，10.1.1.3 机器/data/appdatas/cat/serverm.xml配置如下，仅仅job-machine&amp;alert-machine修改为false</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">local-mode</span>=<span class="string">"false"</span> <span class="attr">hdfs-machine</span>=<span class="string">"false"</span> <span class="attr">job-machine</span>=<span class="string">"false"</span> <span class="attr">alert-machine</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">storage</span>  <span class="attr">local-base-dir</span>=<span class="string">"/data/appdatas/cat/bucket/"</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">"15"</span> <span class="attr">local-report-storage-time</span>=<span class="string">"7"</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"logview"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"logview"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"dump"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"dump"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">"remote"</span> <span class="attr">max-size</span>=<span class="string">"128M"</span> <span class="attr">server-uri</span>=<span class="string">"hdfs://10.1.77.86/user/cat"</span> <span class="attr">base-dir</span>=<span class="string">"remote"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">default-domain</span>=<span class="string">"Cat"</span> <span class="attr">show-cat-domain</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">remote-servers</span>&gt;</span>10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080<span class="tag">&lt;/<span class="name">remote-servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="war打包"><a href="#war打包" class="headerlink" title="war打包"></a>war打包</h3><p>​    1、在cat的源码目录，执行mvn clean install -DskipTests<br>​    2、如果发现cat的war打包不通过，CAT所需要依赖jar都部署在 <a href="http://unidal.org/nexus/" target="_blank" rel="noopener">http://unidal.org/nexus/</a><br>​    3、可以配置这个公有云的仓库地址到本地的settings路径，理论上不需要配置即可，可以参考cat的pom.xml配置</p>
<p> 4、如果自行打包仍然问题，请使用下面链接进行下载<a href="http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/2.0.0/cat-home-2.0.0.war" target="_blank" rel="noopener">http://unidal.org/nexus/service/local/repositories/releases/content/com/dianping/cat/cat-home/2.0.0/cat-home-2.0.0.war</a></p>
<p>​    5、官方的cat的master版本，重命名为cat.war进行部署，注意此war是用jdk8，服务端请使用jdk8版本<br>​    6、如下是个人本机电脑的测试，下载的jar来自于repo1.maven.org 以及 unidal.org</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/codehaus/plexus/plexus-utils/<span class="number">3.0</span>.<span class="number">24</span>/plexus-utils-<span class="number">3.0</span>.<span class="number">24</span>.jar</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/apache/commons/commons-email/<span class="number">1.1</span>/commons-email-<span class="number">1.1</span>.jar (<span class="number">30</span> KB at <span class="number">9.8</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/javax/servlet/jstl/<span class="number">1.2</span>/jstl-<span class="number">1.2</span>.jar (<span class="number">405</span> KB at <span class="number">107.7</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/com/google/code/javaparser/javaparser/<span class="number">1.0</span>.<span class="number">8</span>/javaparser-<span class="number">1.0</span>.<span class="number">8</span>.jar (<span class="number">235</span> KB at <span class="number">55.4</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/codehaus/plexus/plexus-utils/<span class="number">3.0</span>.<span class="number">24</span>/plexus-utils-<span class="number">3.0</span>.<span class="number">24</span>.jar (<span class="number">242</span> KB at <span class="number">46.9</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/org/freemarker/freemarker/<span class="number">2.3</span>.<span class="number">9</span>/freemarker-<span class="number">2.3</span>.<span class="number">9</span>.jar (<span class="number">789</span> KB at <span class="number">113.3</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResServer/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResServer-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResTagLibrary/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResTagLibrary-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResTag/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResTag-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResRuntime/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResRuntime-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResApi/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResApi-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br><span class="line"><span class="symbol">Downloaded:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResApi/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResApi-<span class="number">1.2</span>.<span class="number">1</span>.jar (<span class="number">21</span> KB at <span class="number">82.7</span> KB/sec)</span><br><span class="line"><span class="symbol">Downloading:</span> <span class="symbol">http:</span>/<span class="regexp">/unidal.org/nexus</span><span class="regexp">/content/repositories</span><span class="regexp">/releases/org</span><span class="regexp">/unidal/webres</span><span class="regexp">/WebResBase/</span><span class="number">1.2</span>.<span class="number">1</span>/WebResBase-<span class="number">1.2</span>.<span class="number">1</span>.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">parent</span> ............................................. <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 40.478 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-client</span> ......................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[03:47 min]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-core</span> ........................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 31.740 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-hadoop</span> ......................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[02:50 min]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-consumer</span> ....................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[  3.197 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">cat-home</span> ........................................... <span class="selector-tag">SUCCESS</span> <span class="selector-attr">[ 58.964 s]</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">------------------------------------------------------------------------</span></span><br><span class="line"><span class="selector-attr">[INFO]</span> <span class="selector-tag">BUILD</span> <span class="selector-tag">SUCCESS</span></span><br><span class="line">```</span><br></pre></td></tr></table></figure>
<h3 id="war部署"><a href="#war部署" class="headerlink" title="war部署"></a>war部署</h3><p>​    1、将cat.war部署到10.1.1.1的tomcat的webapps下，启动tomcat，注意webapps下只允许放一个war，仅仅为cat.war<br>​    2、如果发现重启报错，里面有NPE等特殊情况，可以检查当前java进程，ps aux | grep java，可能存在之前的tomcat的进程没有关闭，又新启动了一个，导致出问题，建议kill -9 干掉所有的java进程<br>​    3、打开控制台的URL，<a href="http://10.1.1.1:8080/cat/s/config?op=routerConfigUpdate" target="_blank" rel="noopener">http://10.1.1.1:8080/cat/s/config?op=routerConfigUpdate</a><br>​    4、注意10.1.1.1这个IP需要替换为自己实际的IP链接，修改路由配置只能修改一次即可</p>
<p>​    5、修改路由配置为如下，当为如下配置时，10.1.1.1 正常不起消费数据的作用，仅当10.1.1.2以及10.1.1.3都挂掉才会进行实时流量消费</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;router-config backup-server=<span class="string">"10.1.1.1"</span> backup-server-port=<span class="string">"2280"</span>&gt;</span><br><span class="line">   &lt;<span class="keyword">default</span>-server id=<span class="string">"10.1.1.2"</span> weight=<span class="string">"1.0"</span> port=<span class="string">"2280"</span> enable=<span class="string">"true"</span>/&gt;</span><br><span class="line">   &lt;<span class="keyword">default</span>-server id=<span class="string">"10.1.1.3"</span> weight=<span class="string">"1.0"</span> port=<span class="string">"2280"</span> enable=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;/router-config&gt;</span><br></pre></td></tr></table></figure>
<p>​    6、重启10.1.1.1的机器的tomcat<br>​    7、将cat.war部署到10.1.1.2，10.1.1.3这两台机器中，启动tomcat<br>​    8、cat集群部署完毕，如果有问题，欢迎在微信群咨询，如果文档有误差，欢迎指正以及提交pullrequest</p>
<p>重启保证数据不丢</p>
<p>​    请在tomcat重启之前调用当前tomcat的存储数据的链接 <a href="http://${ip}:8080/cat/r/home?op=checkpoint，重启之后数据会恢复。【注意重启时间在每小时的整点10-55分钟之间】" target="_blank" rel="noopener">http://${ip}:8080/cat/r/home?op=checkpoint，重启之后数据会恢复。【注意重启时间在每小时的整点10-55分钟之间】</a><br> 线上部署时候，建议把此链接调用存放于tomcat的stop脚本中，这样不需要每次手工调用</p>
<h3 id="开发环境CAT的部署"><a href="#开发环境CAT的部署" class="headerlink" title="开发环境CAT的部署"></a>开发环境CAT的部署</h3><p>​    1、请按照如上部署/data/环境目录，数据库配置client.xml ,datasources.xml,server.xml这三个配置文件，注意server.xml里面的节点角色，job-machine&amp;alert-machine都可以配置为true<br>​    2、在cat目录中执行 mvn eclipse:eclipse，此步骤会生成一些代码文件，直接导入到工程会发现找不到类<br>​    3、将源码以普通项目到入eclipse中，注意不要以maven项目导入工程<br>​    4、运行com.dianping.cat.TestServer 这个类，即可启动cat服务器<br>​    5、这里和集群版本唯一区别就是服务端部署单节点，client.xml server.xml以及路由地址配置为单台即可</p>
<h1 id="CAT客户端Demo"><a href="#CAT客户端Demo" class="headerlink" title="CAT客户端Demo"></a>CAT客户端Demo</h1><p>   <strong>cat客户端的配置：</strong></p>
<p>​    cat客户端也需要配置 /data 目录，程序对于/data/目录具体读写权限可以参考上一节，</p>
<p>​    然后通过maven引入cat客户端包，在pom.xml 加入：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​    引入之后：</p>
<p><img src="https://img-blog.csdn.net/20180710112822532" alt="img"></p>
<p>​    以上配置会通过maven从网上引入 cat-core和cat-client 包，如果无法配置引入，也可以手动引入 cat-client.jar 包。</p>
<p>​    CAT默认会将/data/appdatas/cat 作为CAT Home目录，这个目录至关重要，CAT客户端配置文件 client.xml 是在这个目录内，当然，如果你是在 windows 下调试， 你也可以在src/main/resources/ 目录下新建 META-INF/cat 目录， 并将 client.xml 配置文件放入 src/main/resources/META-INF/cat 目录里，你可以为你的监控配置domain，即项目名，如下配置 <domain id="translate"> 。</domain></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">mode</span>=<span class="string">"client"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"config.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">"translate"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Local mode for development --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">ip</span>=<span class="string">"127.0.0.1"</span> <span class="attr">port</span>=<span class="string">"2280"</span> <span class="attr">http-port</span>=<span class="string">"8080"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- If under production environment, put actual server address as list. --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            &lt;server ip="192.168.7.71" port="2280" /&gt; </span></span><br><span class="line"><span class="comment">            &lt;server ip="192.168.7.72" port="2280" /&gt; </span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>第一个监控程序：</strong></p>
<p>​    所有都配置好了，接下来我们来写第一个监控程序，监控都是由用户自己埋点，当然，在本书最后，我们将会讲解CAT监控如何与各个流行框架之间更好的融合，以帮助用户达到无侵入式的监控埋点，假设我们对用户提供了一个翻译服务，其中有个接口就是HelloWorld，在下面程序中，我们将以事务日志形式记录用户调用行为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">helloWorld</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    MessageProducer cat = Cat.getProducer();</span><br><span class="line">    Transaction t = cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"Translate/HelloWorld"</span>);  <span class="comment">//type=URL的事务记录: 你的接口/方法名称</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//do your business</span></span><br><span class="line">        t.setStatus(Message.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Cat.getProducer().logError(e);</span><br><span class="line">        t.setStatus(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        t.complete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    好了，我们再去管理平台去看看报表信息把，Transaction事务报表中，type=URL的事务有3条，我们通常用URL类型的事务消息标志着接口服务的开始，展开之后，我们看到这个里面该项目提供的3个服务被调用了，其中就有我们的 Translate/HelloWorld：</p>
<p><img src="https://img-blog.csdn.net/20180710115701626" alt="img"></p>
<p><img src="https://img-blog.csdn.net/20180710115840344" alt="img"></p>
<p>再点开某个接口的[::show::]进入详细统计，包括耗时分布、每分钟的数据、以及该服务集群下各个机器的统计情况，我们可以通过这个看出是不是某台机器出了问题：</p>
<p><img src="https://img-blog.csdn.net/20180712105601499" alt="img"></p>
<p>点击LogView进入最近一条事务的原始日志（problem报表才会记录全部的原始日志）：</p>
<p><img src="https://img-blog.csdn.net/20180710120047134" alt="img"></p>
<p>​    接下来，我们来看一个更复杂的案例，涉及服务的调用以及数据库、缓存的调用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Translate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; maps = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    <span class="keyword">public</span> Cat.Context context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/translate/getWordMean"</span>, produces = <span class="string">"application/json"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="comment">//获取翻译释义</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getWordMean</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        context = <span class="keyword">new</span> Cat.Context() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProperty</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">                maps.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> maps.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;; <span class="comment">//服务调用消息上下文</span></span><br><span class="line"></span><br><span class="line">        MessageProducer cat = Cat.getProducer();</span><br><span class="line">        Transaction t = cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"translate/getWordMean"</span>);  <span class="comment">//你的接口/方法名称</span></span><br><span class="line">        cat.logEvent(<span class="string">"ClientInfo"</span>, <span class="string">"RemoteIp=127.0.0.1&amp;Referer=..."</span>);  <span class="comment">//记录远程调用端信息</span></span><br><span class="line">        cat.logEvent(<span class="string">"Payload"</span>, <span class="string">"HTTP/GET /translate/getWordMean?client=3&amp;clientVersion=0&amp;v=9.5&amp;uid=3214567...."</span>); <span class="comment">//调用端参数</span></span><br><span class="line">        <span class="comment">//用户校验</span></span><br><span class="line">        authCheck();</span><br><span class="line">        <span class="comment">//先从缓存Redis获取结果</span></span><br><span class="line">        Transaction cacheT = cat.newTransaction(<span class="string">"Cache.memcached.redis"</span>, <span class="string">"translate_result:get"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"Cache.memcached.redis.server"</span>, <span class="string">"127.0.0.1:6379"</span>);</span><br><span class="line">        <span class="comment">//do your cache operation</span></span><br><span class="line">        cacheT.setStatus(Message.SUCCESS);</span><br><span class="line">        cacheT.complete();</span><br><span class="line">        <span class="comment">//do your translate operation</span></span><br><span class="line">        <span class="comment">//记录远程语音服务调用</span></span><br><span class="line">        Transaction callT = cat.newTransaction(<span class="string">"Call"</span>, <span class="string">"voice:getVoice"</span>);</span><br><span class="line">        Cat.logEvent(<span class="string">"Call.server"</span>,<span class="string">"localhost"</span>);  <span class="comment">//远程服务地址</span></span><br><span class="line">        Cat.logEvent(<span class="string">"Call.app"</span>,<span class="string">"voice"</span>);   <span class="comment">//语音服务</span></span><br><span class="line">        Cat.logEvent(<span class="string">"Call.port"</span>,<span class="string">"8080"</span>);   <span class="comment">//语音服务端口</span></span><br><span class="line">        Cat.logRemoteCallClient(context); <span class="comment">//生成消息调用上下文，主要是几个messageId的创建。</span></span><br><span class="line"></span><br><span class="line">        voiceService(context); </span><br><span class="line">        callT.setStatus(Message.SUCCESS);</span><br><span class="line">        callT.complete();</span><br><span class="line">        OutputData result = <span class="keyword">new</span> OutputData();</span><br><span class="line">        result.setErrno(<span class="number">0</span>);</span><br><span class="line">        result.setErrmsg(<span class="string">"success"</span>);</span><br><span class="line">        result.setTranslateResult(<span class="string">"translate result ..."</span>);</span><br><span class="line"></span><br><span class="line">        t.setStatus(Message.SUCCESS);</span><br><span class="line">        t.complete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">authCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MessageProducer cat = Cat.getProducer();</span><br><span class="line">        Transaction checkUser = cat.newTransaction(<span class="string">"Method"</span>, <span class="string">"checkAuth"</span>);</span><br><span class="line">        <span class="comment">//从数据库查询用户信息</span></span><br><span class="line">        Transaction sqlT = cat.newTransaction(<span class="string">"SQL"</span>, <span class="string">"Select"</span>);</span><br><span class="line"></span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Database"</span>, <span class="string">"jdbc:mysql://127.0.0.1:3306/user"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Method"</span>, <span class="string">"select"</span>);</span><br><span class="line">        cat.logEvent(<span class="string">"SQL.Statement"</span>, <span class="string">"SELECT"</span>, Message.SUCCESS, <span class="string">"select * from user_info"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//to do your SQL query</span></span><br><span class="line">        sqlT.setStatus(Message.SUCCESS);</span><br><span class="line">        sqlT.complete();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//to do your auth check</span></span><br><span class="line">        checkUser.setStatus(Message.SUCCESS);</span><br><span class="line">        checkUser.complete();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//线程模拟语音服务</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">voiceService</span><span class="params">(<span class="keyword">final</span> Cat.Context context)</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//服务器埋点，Domain为 voice 提供语音服务</span></span><br><span class="line">                Cat.getManager().getThreadLocalMessageTree().setDomain(<span class="string">"voice"</span>);</span><br><span class="line">                MessageProducer cat = Cat.getProducer();</span><br><span class="line">                Transaction voiceService = Cat.newTransaction(<span class="string">"URL"</span>, <span class="string">"voice/getVoice"</span>); <span class="comment">//你的接口/方法名称</span></span><br><span class="line">                cat.logEvent(<span class="string">"ClientInfo"</span>, <span class="string">"RemoteIp=127.0.0.1&amp;Referer=..."</span>);  <span class="comment">//记录远程调用端信息</span></span><br><span class="line">                cat.logEvent(<span class="string">"Payload"</span>, <span class="string">"HTTP/GET /voice/getVoice?client=3&amp;clientVersion=0&amp;v=9.5&amp;uid=3214567...."</span>); <span class="comment">//调用端参数</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//记录服务信息</span></span><br><span class="line">                Transaction child = Cat.newTransaction(<span class="string">"Service"</span>, <span class="string">"voice:getVoice"</span>);</span><br><span class="line">                Cat.logEvent(<span class="string">"Service.client"</span>, <span class="string">"localhost"</span>); <span class="comment">//客户端地址</span></span><br><span class="line">                Cat.logEvent(<span class="string">"Service.app"</span>, <span class="string">"translate"</span>); <span class="comment">//客户端domain</span></span><br><span class="line">                Cat.logRemoteCallServer(context); <span class="comment">//记录消息上下文</span></span><br><span class="line">                <span class="comment">//to do your business</span></span><br><span class="line">                child.setStatus(Message.SUCCESS);</span><br><span class="line">                child.complete();</span><br><span class="line">                voiceService.setStatus(Message.SUCCESS);</span><br><span class="line">                voiceService.complete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">        <span class="comment">// wait for it to complete</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// ignore it</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    这是我们一个对外提供的翻译服务，getWordMean为服务控制器入口，我们将原始消息展开如下，整个服务处理耗时571ms，一进来我们会记录URL类型事务，以及调用参数，然后记录用户校验函数，在函数内部，有查询用户信息的数据库操作，也会被记录下，查询耗时150ms，接下来我们会先从缓存获取结果， 缓存查询耗时 59ms，随后我们翻译内容，翻译之后我们会调用语音服务提供的发音接口，voice/getVoice，发音接口调用一共耗时 361 ms。</p>
<p><img src="https://img-blog.csdn.net/20180710170905183" alt="img"></p>
<p><a href="https://blog.csdn.net/caohao0591/article/details/80207771" target="_blank" rel="noopener">下一篇：   CAT跨语言服务链监控（二） CAT服务端初始化</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/16/深入详解美团点评CAT跨语言服务监控（一） CAT简介与部署/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/02/12/Vue/">
                            (无标题)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-02-12T18:47:58+08:00">
	
		    2月 12, 2019
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h1><p>Vue官网：<a href="https://cn.vuejs.org/" target="_blank" rel="noopener">https://cn.vuejs.org/</a></p>
<p>脚手架：<a href="https://cli.vuejs.org/zh/" target="_blank" rel="noopener">https://cli.vuejs.org/zh/</a></p>
<p>路由：<a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener">https://router.vuejs.org/zh/</a></p>
<p>Vue菜鸟教程：<a href="http://www.runoob.com/vue2/vue-tutorial.html" target="_blank" rel="noopener">http://www.runoob.com/vue2/vue-tutorial.html</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/02/12/Vue/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/09/04/data-structures&algorithms/">
                            data structures &amp; algorithms
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-09-04T13:44:00+08:00">
	
		    9月 04, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    
                    
                        

                    
                    
                        <p>
                            <a href="/2018/09/04/data-structures&algorithms/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2018/02/07/nginx-pan-domain-name/">
                            Nginx进行泛域名解析
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-02-07T17:55:52+08:00">
	
		    2月 07, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>##nginx泛域名解析，实现多个二级域名</p>
<p>利用nginx泛域名解析配置二级域名和多域名，实现二级域名子站，用户个性独立子域名。</p>
<p>主要针对用户独立子域名这种情况，不可能在配置里面将用户子域名写完，因此需要通过nginx泛解析方式。</p>
<p>配置方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name  ~^(?&lt;subdomain&gt;.+)\.yourdomain\.com$;</span><br></pre></td></tr></table></figure>
<p>通过匹配subdomain即可。而在下面的可以通过$subdomain这个变量获取当前子域名称。</p>
<h3 id="情况一：绑定子域名到统一目录，作为用户个性域名"><a href="#情况一：绑定子域名到统一目录，作为用户个性域名" class="headerlink" title="情况一：绑定子域名到统一目录，作为用户个性域名"></a>情况一：绑定子域名到统一目录，作为用户个性域名</h3><p>这种情况下，只需要直接匹配就可以了，目录都是指向同一个地方的（一般）。</p>
<p><strong>配置实例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen   80;</span><br><span class="line">    server_name yourdomain.com www.yourdomain.cpm ~^(?&lt;subdomain&gt;.+)\.m\.yourdomain\.com$;</span><br><span class="line"></span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$root_path</span> <span class="string">'/var/www/yanue.net'</span>;</span><br><span class="line">    root <span class="variable">$root_path</span>;</span><br><span class="line"></span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ @rewrite;</span><br><span class="line"></span><br><span class="line">    location @rewrite &#123;</span><br><span class="line">        rewrite ^/(.*)$ /index.php?_url=/<span class="variable">$1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* ^/(css|img|js|flv|swf|download)/(.+)$ &#123;</span><br><span class="line">        root <span class="variable">$root_path</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以实现：</p>
<p><code>user.m.yourdomain.com</code> 跳转到用户自己页面</p>
<p>当然跳转逻辑需要自己在程序里面去实现。</p>
<h3 id="情况二：绑定子域名到不同目录（子站）"><a href="#情况二：绑定子域名到不同目录（子站）" class="headerlink" title="情况二：绑定子域名到不同目录（子站）"></a>情况二：绑定子域名到不同目录（子站）</h3><p>网站的目录结构为</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">├── bbs</span><br><span class="line">└── www</span><br></pre></td></tr></table></figure>
<p>html为nginx的安装目录下默认的存放源代码的路径。</p>
<p>bbs为论坛程序源代码路径</p>
<p>www为主页程序源代码路径</p>
<p>把相应程序放入上面的路径通过</p>
<p><a href="http://www.youdomain.com" target="_blank" rel="noopener">http://www.youdomain.com</a> 访问的就是主页</p>
<p><a href="http://bbs.yourdomain.com" target="_blank" rel="noopener">http://bbs.yourdomain.com</a> 访问的就是论坛</p>
<p>其它二级域名类推。</p>
<p><strong>配置实例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  ~^(?&lt;subdomain&gt;.+)\.yourdomain\.com$;</span><br><span class="line">        root   html/<span class="variable">$subdomain</span>; </span><br><span class="line">        index  index.html index.htm index.php;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        error_page  404      = /404.html;</span><br><span class="line">        location / &#123;</span><br><span class="line">                <span class="comment"># This is cool because no php is touched for static content.</span></span><br><span class="line">                <span class="comment"># include the "?$args" part so non-default permalinks doesn't</span></span><br><span class="line">                <span class="comment"># break when using query string</span></span><br><span class="line">                try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            fastcgi_param  domain <span class="variable">$subdomain</span>;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx's one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        location ~ /\.ht &#123;</span><br><span class="line">            deny  all;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/02/07/nginx-pan-domain-name/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/09/19/algorithm/">
                            algorithm
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-09-19T15:42:24+08:00">
	
		    9月 19, 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h4 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h4><p>将后面的元素插入前面已经排序好的序列中<br>循环每一个元素<br>从第二个元素开始循环，逆序与前面每一个元素比较(默认前面元素已经是排序好的)，如果小于则交换<br>[8, 7, 6, 5, 4, 3, 2, 1]<br>先选出7，逆序循环与前面排序好的[8]比较，小于交换<br>[7, 8, 6, 5, 4, 3, 2, 1]<br>选出6，逆序循环与前面排序好的[7,8]比较，小于交换<br>[7, 6, 8, 5, 4, 3, 2, 1]<br>[6, 7, 8, 5, 4, 3, 2, 1]<br>一次类推</p>
<h4 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h4><p>根据序列长度分组后，对每个组进行插入排序<br>循环对数组分组，分完的组进行插入排序<br>[8, 7, 6, 5, 4, 3, 2, 1]<br>根据长度分组len(L)/2 = 4, gap = 4<br>[L[0], L[0 + 4]], [L[1], L[1 + 4]…<br>[8, 4], [7, 3], [6, 2], [5, 1] -&gt; [4, 8], [3, 7], [2, 6], [1, 5]<br>[4,3,2,1,8,7,6,5]<br>gap /= 2<br>[L[0], L[0 + 2], L[0 + 4], L[0 + 6]]…<br>[4, 2, 8, 6] [3, 1, 7, 5] -&gt; [2, 4, 6, 8] [1, 3, 5, 7]<br>gap /= 2<br>[2, 1, 4, 3, 6, 5, 8, 7]<br>gap /= 2<br>[2, 1, 4, 3, 6, 5, 8, 7] -&gt; [1, 2, 3, 4, 5, 6, 7, 8]</p>
<h4 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h4><p>选择待排序子序列中最小值，最小值换到第一位置<br>[8, 7, 6, 5, 4, 3, 2, 1]<br>[1, 7, 6, 5, 4, 3, 2, 8]<br>[1, 2, 6, 5, 4, 3, 7, 8]<br>[1, 2, 3, 5, 4, 6, 7, 8]…</p>
<h4 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h4><h4 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h4><p>从第一个元素比较，将大的元素往后面移<br>[8, 7, 6, 5, 4, 3, 2, 1]<br>[7, 8, 6, 5, 4, 3, 2, 1]…<br>[7, 6, 5, 4, 3, 2, 1, 8]…</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/09/19/algorithm/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/09/19/HTML5 惊艳 demo/">
                            HTML5 惊艳 demo
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-09-19T15:42:24+08:00">
	
		    9月 19, 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h4 id="HTML5-惊艳-demo"><a href="#HTML5-惊艳-demo" class="headerlink" title="HTML5 惊艳 demo"></a>HTML5 惊艳 demo</h4><p>链接：<a href="https://www.zhihu.com/question/24398907/answer/30239864" target="_blank" rel="noopener">https://www.zhihu.com/question/24398907/answer/30239864</a></p>
<p>来源：知乎</p>
<p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<p>找不到之前所见过的网页，深有同感！<br><a href="https://link.zhihu.com/?target=http%3A//tympanus.net/Development/AnimatedBooks/" target="_blank" rel="noopener">Animated Books with CSS 3D Transforms</a>  这是一个3D书本，CSS3完成</p>
<p>=========HTML5特效聚集网站========<br><a href="https://link.zhihu.com/?target=http%3A//christmasexperiments.com/" target="_blank" rel="noopener">christmasexperiments.com 的页面</a><br><a href="https://link.zhihu.com/?target=http%3A//www.chromeexperiments.com/" target="_blank" rel="noopener">chromeexperiments.com 的页面</a><br><a href="https://link.zhihu.com/?target=http%3A//www.mrdoob.com/" target="_blank" rel="noopener">Mr.doob</a><br><a href="https://link.zhihu.com/?target=http%3A//litewerx.dk/" target="_blank" rel="noopener">litewerx.showcase</a><br><a href="https://link.zhihu.com/?target=http%3A//fff.cmiscm.com/%23%21/main" target="_blank" rel="noopener">Form Follows Function</a><br><a href="https://link.zhihu.com/?target=http%3A//alteredqualia.com/" target="_blank" rel="noopener">AlteredQualia</a><br><a href="https://link.zhihu.com/?target=http%3A//www.html5rocks.com/en/resources" target="_blank" rel="noopener">html5rocks.com 的页面</a></p>
<p>===========视觉特效与交互式视频============<br><a href="https://link.zhihu.com/?target=http%3A//www.thewildernessdowntown.com/" target="_blank" rel="noopener">http://www.thewildernessdowntown.com/</a><br><a href="https://link.zhihu.com/?target=http%3A//www.itsumokawaii.jp/en/" target="_blank" rel="noopener">Interactive Film “itsumo kawaii”</a><br><a href="https://link.zhihu.com/?target=http%3A//www.beonlineb.com/" target="_blank" rel="noopener">http://www.beonlineb.com/</a><br><a href="https://link.zhihu.com/?target=http%3A//www.justareflektor.com/" target="_blank" rel="noopener">Arcade Fire / Just a Reflektor</a><br><a href="https://link.zhihu.com/?target=http%3A//www.aaronkoblin.com/Aaronetrope/" target="_blank" rel="noopener">Aaronetrope</a>  3D科幻视频投影对话<br><a href="https://link.zhihu.com/?target=http%3A//aleksandarrodic.com/" target="_blank" rel="noopener">Aleksandar Rodic</a> 3D立体博客<br><a href="https://link.zhihu.com/?target=http%3A//inear.se/beanstalk/" target="_blank" rel="noopener">Beanstalk</a><br><a href="https://link.zhihu.com/?target=http%3A//www.ro.me/" target="_blank" rel="noopener">http://www.ro.me/</a><br><a href="https://link.zhihu.com/?target=http%3A//alteredqualia.com/three/examples/webgl_terrain_dynamic.html" target="_blank" rel="noopener">three.js webgl</a> 动态地图<br><a href="https://link.zhihu.com/?target=http%3A//ogreen.special-t.com/en/" target="_blank" rel="noopener">Ô Green by SPECIAL.T</a> 水中植物广告<br><a href="https://link.zhihu.com/?target=http%3A//kimatica.net/%23/leafs/" target="_blank" rel="noopener">Kimatica - Creative Connections</a> 树脉<br><a href="https://link.zhihu.com/?target=http%3A//callhimecho.com/%23" target="_blank" rel="noopener">Earth to Echo</a> 电影科幻宣传网站<br><a href="https://link.zhihu.com/?target=http%3A//middle-earth.thehobbit.com/map" target="_blank" rel="noopener">http://middle-earth.thehobbit.com/map</a> 霍比特人<br><a href="https://link.zhihu.com/?target=http%3A//hellorun.helloenjoy.com/" target="_blank" rel="noopener">HelloRun™</a>  线稿房间，第一人称动<br><a href="https://link.zhihu.com/?target=http%3A//letters-inc.jp/%3Ft%3Dd" target="_blank" rel="noopener">LETTERS, INC.</a> 集成电路<br><a href="https://link.zhihu.com/?target=http%3A//dataveyes.com/%23%21/en" target="_blank" rel="noopener">Dataveyes | Human Data Interactions</a> 视觉粒子</p>
<p>=========音乐与可视化==========<br><a href="https://link.zhihu.com/?target=http%3A//do.adive.in/" target="_blank" rel="noopener">http://do.adive.in/</a><br><a href="https://link.zhihu.com/?target=http%3A//www.clicktorelease.com/code/rocking-dendrites/" target="_blank" rel="noopener">Rocking dendrites</a> 摇滚与触手<br><a href="https://link.zhihu.com/?target=http%3A//jabtunes.com/labs/arabesque/" target="_blank" rel="noopener">Arabesque - Music Colour Particles</a> 优美的纯音乐与彩色烟雾<br><a href="https://link.zhihu.com/?target=http%3A//blackpawn.com/demos/vrtx-01-compo-filler/" target="_blank" rel="noopener">compo.filler</a>  蓝电之音<br><a href="https://link.zhihu.com/?target=http%3A//lights.helloenjoy.com/" target="_blank" rel="noopener">Lights</a> 波点<br><a href="https://link.zhihu.com/?target=http%3A//www.airtightinteractive.com/demos/js/uberviz/wordproblems/" target="_blank" rel="noopener">ĂberViz</a> 电子<br>[A <a href="https://link.zhihu.com/?target=http%3A//www.nihilogic.dk/labs/canvas_music_visualization/" target="_blank" rel="noopener"> Radiohead</a>   音乐画画</p>
<p>=========物理特性元素============<br><a href="https://link.zhihu.com/?target=http%3A//hakim.se/experiments/html5/blob/03/" target="_blank" rel="noopener">Blob </a> 大水球<br><a href="https://link.zhihu.com/?target=http%3A//andrew-hoyer.com/experiments/cloth/" target="_blank" rel="noopener">Andrew Hoyer</a> 布-骨架<br><a href="https://link.zhihu.com/?target=http%3A//ie.microsoft.com/testdrive/Performance/FishBowl/" target="_blank" rel="noopener">HTML5 Fish Bowl</a> IE-鱼缸<br><a href="https://link.zhihu.com/?target=http%3A//webglsamples.googlecode.com/hg/aquarium/aquarium.html" target="_blank" rel="noopener">googlecode.com 的页面</a> chrome-水族馆<br><a href="https://link.zhihu.com/?target=http%3A//alteredqualia.com/three/examples/webgl_animals.html" target="_blank" rel="noopener">three.js webgl</a> 动物<br><a href="https://link.zhihu.com/?target=http%3A//www.spielzeugz.de/html5/liquid-particles-3D/" target="_blank" rel="noopener">Liquid Particles 3D</a> 3D粒子流</p>
<p>==========画绘与生成===========<br><a href="https://link.zhihu.com/?target=http%3A//www.queness.com/post/4650/10-jaw-dropping-html5-and-javascript-effects" target="_blank" rel="noopener">10 Jaw Dropping HTML5 and Javascript Effects</a>  10个画绘特效<br><a href="https://link.zhihu.com/?target=http%3A//html5-pro.com/wormz/" target="_blank" rel="noopener">wormz . html5 canvas experiment</a> 图片生成毛毛虫~~<br><a href="https://link.zhihu.com/?target=http%3A//weavesilk.com/" target="_blank" rel="noopener">Silk – Interactive Generative Art</a>  光效<br><a href="https://link.zhihu.com/?target=http%3A//sketchtoy.com/" target="_blank" rel="noopener">Sketch Toy: Draw sketches and share replays with friends!</a> 记录线稿步骤<br><a href="https://link.zhihu.com/?target=http%3A//asciiflow.com/" target="_blank" rel="noopener">ASCIIFlow Infinity</a> ASCII字符生成图表</p>
<p>========一些融入了HTML5的网站=======<br><a href="https://link.zhihu.com/?target=http%3A//andrevv.com/" target="_blank" rel="noopener">Andrew McCarthy</a>  滚动动物奔跑<br><a href="https://link.zhihu.com/?target=http%3A//tokyomildfoundation.com/" target="_blank" rel="noopener">http://tokyomildfoundation.com/</a>  东京温柔基金<br><a href="https://link.zhihu.com/?target=http%3A//www.fifty-five.com/" target="_blank" rel="noopener">fifty-five | the data agency</a>  垂直分割<br><a href="https://link.zhihu.com/?target=http%3A//aprilzero.com/" target="_blank" rel="noopener">A P R I L Z E R O</a>  数据分析<br><a href="https://link.zhihu.com/?target=http%3A//gamingmedia.ru/" target="_blank" rel="noopener">Gaming Media</a> 创意横向滚动<br><a href="https://link.zhihu.com/?target=http%3A//www.luxaqua-design.com/" target="_blank" rel="noopener">Luxaqua | Aquarium Design</a> 深邃海底纵向滚动<br><a href="https://link.zhihu.com/?target=http%3A//www.kilfish.com/" target="_blank" rel="noopener">KILFISH</a>  鬼畜纵向滚动<br><a href="https://link.zhihu.com/?target=http%3A//fullten-plums.com.tw/" target="_blank" rel="noopener">有顆梅，在台灣</a>  食品纵向滚动<br><a href="https://link.zhihu.com/?target=http%3A//www.vespillo-lefilm.com/" target="_blank" rel="noopener">Vespillo le film</a>  Vespillo纵向滚动<br><a href="https://link.zhihu.com/?target=http%3A//moonbear.animalsasia.org/ie/en/" target="_blank" rel="noopener">Exploring Moon Bears</a> IE-月熊志<br><a href="https://link.zhihu.com/?target=http%3A//metaljunkthegame.com/" target="_blank" rel="noopener">Metal Junk: The Game</a> HTML5游戏：金属废墟，游戏就不展开了~~</p>
<p>最近写的 基于 HTML5 的指南针和水平仪：<a href="https://link.zhihu.com/?target=http%3A//island205.github.io/H5Compass/" target="_blank" rel="noopener">H5Compass</a> iPhone 5s/5c 测试可用</p>
<p>最近看到一个惊艳的HTML5网站，<a href="https://link.zhihu.com/?target=http%3A//species-in-pieces.com/%23" target="_blank" rel="noopener">In Pieces - 30 Endangered Species, 30 Pieces.</a></p>
<p><a href="https://link.zhihu.com/?target=http%3A//tympanus.net/codrops/" target="_blank" rel="noopener">Codrops | Useful resources and inspiration for creative minds</a><br><a href="https://link.zhihu.com/?target=http%3A//tutorialzine.com/" target="_blank" rel="noopener">Tutorialzine</a><br>上面有很多的Demo，质量都很高，开源免费可商用</p>
<p>还有<a href="https://link.zhihu.com/?target=http%3A//codepen.io/" target="_blank" rel="noopener">CodePen - Front End Developer Playground &amp; Code Editor in the Browser</a>，像是前端界的github</p>
<p>3D立体书Codrops上有几个，不知道是不是你找的：<br><a href="https://link.zhihu.com/?target=http%3A//tympanus.net/Development/AnimatedBooks/index.html" target="_blank" rel="noopener">Animated Books with CSS 3D Transforms</a><br><a href="https://link.zhihu.com/?target=http%3A//tympanus.net/Tutorials/3DShadingWithBoxShadows/" target="_blank" rel="noopener">3D Shading with Box-Shadows</a><br><a href="https://link.zhihu.com/?target=http%3A//tympanus.net/Development/3DBookShowcase/index.html" target="_blank" rel="noopener">3D Book Showcase</a></p>
<p><a href="https://www.uisdc.com/10-best-free-animation-libraries" target="_blank" rel="noopener">https://www.uisdc.com/10-best-free-animation-libraries</a></p>
<h5 id="WOW-js-–-让页面滚动更有趣"><a href="#WOW-js-–-让页面滚动更有趣" class="headerlink" title="WOW.js – 让页面滚动更有趣"></a><a href="https://link.jianshu.com?t=https%3A%2F%2Fgithub.com%2Fmatthieua%2FWOW" target="_blank" rel="noopener">WOW.js – 让页面滚动更有趣</a></h5><p>使用说明：<a href="https://link.jianshu.com?t=http%3A%2F%2Fwww.dowebok.com%2F131.html" target="_blank" rel="noopener">链接地址</a><br> 演示地址：<a href="https://link.jianshu.com?t=http%3A%2F%2Fwww.dowebok.com%2Fdemo%2F131%2Findex2.html" target="_blank" rel="noopener">OW.js演示-oppo官网首页</a></p>
<h5 id="jQuery全屏滚动插件fullPage-js"><a href="#jQuery全屏滚动插件fullPage-js" class="headerlink" title="jQuery全屏滚动插件fullPage.js"></a><a href="https://link.jianshu.com?t=https%3A%2F%2Fgithub.com%2Falvarotrigo%2Ffullpage.js%2F" target="_blank" rel="noopener">jQuery全屏滚动插件<em>fullPage.js</em></a></h5><p>官网地址：<a href="https://link.jianshu.com?t=https%3A%2F%2Falvarotrigo.com%2FfullPage%2F" target="_blank" rel="noopener">链接地址</a><br> 使用说明：<a href="https://link.jianshu.com?t=http%3A%2F%2Fwww.jq22.com%2Fjquery-info1124" target="_blank" rel="noopener">链接地址</a><br> 演示地址：<a href="https://link.jianshu.com?t=http%3A%2F%2Fwww.jq22.com%2Fyanshi1124" target="_blank" rel="noopener">链接地址</a></p>
<h5 id="Animate-css-一款强大的预设css3动画库"><a href="#Animate-css-一款强大的预设css3动画库" class="headerlink" title="Animate.css 一款强大的预设css3动画库"></a><a href="https://link.jianshu.com?t=https%3A%2F%2Fgithub.com%2Fdaneden%2Fanimate.css" target="_blank" rel="noopener">Animate.css 一款强大的预设css3动画库</a></h5><p>官网地址：<a href="https://link.jianshu.com?t=https%3A%2F%2Fdaneden.github.io%2Fanimate.css%2F" target="_blank" rel="noopener">链接地址</a><br> 使用说明：<a href="https://link.jianshu.com?t=https%3A%2F%2Fwww.awesomes.cn%2Frepo%2Fdaneden%2Fanimate-css" target="_blank" rel="noopener">链接地址</a><br> 演示地址：<a href="https://link.jianshu.com?t=http%3A%2F%2Fwww.jq22.com%2Fyanshi819" target="_blank" rel="noopener">链接地址</a></p>
<p>Loading</p>
<p><a href="https://loading.io/" target="_blank" rel="noopener">https://loading.io/</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/09/19/HTML5 惊艳 demo/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/09/19/java 如何实现一个简单的RPC/">
                            Java 如何实现一个简单的RPC
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-09-19T15:42:24+08:00">
	
		    9月 19, 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Java-如何实现一个简单的RPC"><a href="#Java-如何实现一个简单的RPC" class="headerlink" title="Java 如何实现一个简单的RPC"></a>Java 如何实现一个简单的RPC</h1><h1 id="RPC的实现原理"><a href="#RPC的实现原理" class="headerlink" title="RPC的实现原理"></a>RPC的实现原理</h1><p>正如上一讲所说，RPC主要是为了解决的两个问题：</p>
<ul>
<li>解决分布式系统中，服务之间的调用问题。</li>
<li>远程调用时，要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑。</li>
</ul>
<p>还是以计算器Calculator为例，如果实现类CalculatorImpl是放在本地的，那么直接调用即可：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/7143349-69563e8ebc25c77c.png?imageMogr2/auto-orient/" alt="img"></p>
<p>现在系统变成分布式了，CalculatorImpl和调用方不在同一个地址空间，那么就必须要进行远程过程调用：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/7143349-d5f7290907ce3cca.png?imageMogr2/auto-orient/" alt="img"></p>
<p>那么如何实现远程过程调用，也就是RPC呢，一个完整的RPC流程，可以用下面这张图来描述：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/7143349-a9db3c3c85194c6e.png?imageMogr2/auto-orient/" alt="img"></p>
<p>其中左边的Client，对应的就是前面的Service A，而右边的Server，对应的则是Service B。<br>下面一步一步详细解释一下。</p>
<ol>
<li>Service A的应用层代码中，调用了Calculator的一个实现类的add方法，希望执行一个加法运算；</li>
<li>这个Calculator实现类，内部并不是直接实现计算器的加减乘除逻辑，而是通过远程调用Service B的RPC接口，来获取运算结果，因此称之为<strong>Stub</strong>；</li>
<li>Stub怎么和Service B建立远程通讯呢？这时候就要用到<strong>远程通讯工具</strong>了，也就是图中的<strong>Run-time Library</strong>，这个工具将帮你实现远程通讯的功能，比如Java的<strong>Socket</strong>，就是这样一个库，当然，你也可以用基于Http协议的<strong>HttpClient</strong>，或者其他通讯工具类，都可以，<strong>RPC并没有规定说你要用何种协议进行通讯</strong>；</li>
<li>Stub通过调用通讯工具提供的方法，和Service B建立起了通讯，然后将请求数据发给Service B。需要注意的是，由于底层的网络通讯是基于<strong>二进制格式</strong>的，因此这里Stub传给通讯工具类的数据也必须是二进制，比如calculator.add(1,2)，你必须把参数值1和2放到一个Request对象里头（这个Request对象当然不只这些信息，还包括要调用哪个服务的哪个RPC接口等其他信息），然后<strong>序列化</strong>为二进制，再传给通讯工具类，这一点也将在下面的代码实现中体现；</li>
<li>二进制的数据传到Service B这一边了，Service B当然也有自己的通讯工具，通过这个通讯工具接收二进制的请求；</li>
<li>既然数据是二进制的，那么自然要进行<strong>反序列化</strong>了，将二进制的数据反序列化为请求对象，然后将这个请求对象交给Service B的Stub处理；</li>
<li>和之前的Service A的Stub一样，这里的Stub也同样是个“假玩意”，它所负责的，只是去解析请求对象，知道调用方要调的是哪个RPC接口，传进来的参数又是什么，然后再把这些参数传给对应的RPC接口，也就是Calculator的实际实现类去执行。很明显，如果是Java，那这里肯定用到了<strong>反射</strong>。</li>
<li>RPC接口执行完毕，返回执行结果，现在轮到Service B要把数据发给Service A了，怎么发？一样的道理，一样的流程，只是现在Service B变成了Client，Service A变成了Server而已：Service B反序列化执行结果-&gt;传输给Service A-&gt;Service A反序列化执行结果 -&gt; 将结果返回给Application，完毕。</li>
</ol>
<p>理论的讲完了，是时候把理论变成实践了。</p>
<h1 id="把理论变成实践"><a href="#把理论变成实践" class="headerlink" title="把理论变成实践"></a>把理论变成实践</h1><blockquote>
<p>本文的示例代码，可到<a href="https://github.com/hzy38324/simple-rpc" target="_blank" rel="noopener">Github</a>下载。</p>
</blockquote>
<p>首先是Client端的应用层怎么发起RPC，ComsumerApp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComsumerApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Calculator calculator = <span class="keyword">new</span> CalculatorRemoteImpl();</span><br><span class="line">        <span class="keyword">int</span> result = calculator.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>通过一个CalculatorRemoteImpl，我们把RPC的逻辑封装进去了，客户端调用时感知不到远程调用的麻烦</strong>。下面再来看看CalculatorRemoteImpl，代码有些多，但是其实就是把上面的2、3、4几个步骤用代码实现了而已，CalculatorRemoteImpl：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatorRemoteImpl</span> <span class="keyword">implements</span> <span class="title">Calculator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; addressList = lookupProviders(<span class="string">"Calculator.add"</span>);</span><br><span class="line">        String address = chooseTarget(addressList);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Socket socket = <span class="keyword">new</span> Socket(address, PORT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将请求序列化</span></span><br><span class="line">            CalculateRpcRequest calculateRpcRequest = generateRequest(a, b);</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将请求发给服务提供方</span></span><br><span class="line">            objectOutputStream.writeObject(calculateRpcRequest);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将响应体反序列化</span></span><br><span class="line">            ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">            Object response = objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Integer) response;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"fail"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add方法的前面两行，lookupProviders和chooseTarget，可能大家会觉得不明觉厉。</p>
<p>分布式应用下，一个服务可能有多个实例，比如Service B，可能有ip地址为198.168.1.11和198.168.1.13两个实例，lookupProviders，其实就是在寻找要调用的服务的实例列表。在分布式应用下，通常会有一个<strong>服务注册中心</strong>，来提供查询实例列表的功能。</p>
<p>查到实例列表之后要调用哪一个实例呢，只时候就需要chooseTarget了，其实内部就是一个<strong>负载均衡</strong>策略。</p>
<p>由于我们这里只是想实现一个简单的RPC，所以暂时不考虑服务注册中心和负载均衡，因此代码里写死了返回ip地址为127.0.0.1。</p>
<p>代码继续往下走，我们这里用到了Socket来进行远程通讯，同时利用<strong>ObjectOutputStream</strong>的writeObject和<strong>ObjectInputStream</strong>的readObject，来实现序列化和反序列化。</p>
<p>最后再来看看Server端的实现，和Client端非常类似，ProviderApp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderApp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Calculator calculator = <span class="keyword">new</span> CalculatorImpl();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ProviderApp().run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ServerSocket listener = <span class="keyword">new</span> ServerSocket(<span class="number">9090</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Socket socket = listener.accept();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 将请求反序列化</span></span><br><span class="line">                    ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">                    Object object = objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">                    log.info(<span class="string">"request is &#123;&#125;"</span>, object);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 调用服务</span></span><br><span class="line">                    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> CalculateRpcRequest) &#123;</span><br><span class="line">                        CalculateRpcRequest calculateRpcRequest = (CalculateRpcRequest) object;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"add"</span>.equals(calculateRpcRequest.getMethod())) &#123;</span><br><span class="line">                            result = calculator.add(calculateRpcRequest.getA(), calculateRpcRequest.getB());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 返回结果</span></span><br><span class="line">                    ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">                    objectOutputStream.writeObject(<span class="keyword">new</span> Integer(result));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"fail"</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listener.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Server端主要是通过ServerSocket的accept方法，来接收Client端的请求，接着就是反序列化请求-&gt;执行-&gt;序列化执行结果，最后将二进制格式的执行结果返回给Client。</p>
<p><strong>就这样我们实现了一个简陋而又详细的RPC。</strong><br>说它简陋，是因为这个实现确实比较挫，在下一小节会说它为什么挫。<br>说它详细，是因为它一步一步的演示了一个RPC的执行流程，方便大家了解RPC的内部机制。</p>
<h1 id="为什么说这个RPC实现很挫"><a href="#为什么说这个RPC实现很挫" class="headerlink" title="为什么说这个RPC实现很挫"></a>为什么说这个RPC实现很挫</h1><p>这个RPC实现只是为了给大家演示一下RPC的原理，要是想放到生产环境去用，那是绝对不行的。</p>
<p>1、缺乏通用性<br>我通过给Calculator接口写了一个CalculatorRemoteImpl，来实现计算器的远程调用，下一次要是有别的接口需要远程调用，是不是又得再写对应的远程调用实现类？这肯定是很不方便的。</p>
<p>那该如何解决呢？先来看看使用Dubbo时是如何实现RPC调用的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reference</span></span><br><span class="line"><span class="keyword">private</span> Calculator calculator;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">calculator.add(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Dubbo通过和Spring的集成，在Spring容器初始化的时候，如果扫描到对象加了@Reference注解，那么就给这个对象生成一个代理对象，这个代理对象会负责远程通讯，然后将代理对象放进容器中。所以代码运行期用到的calculator就是那个代理对象了。</p>
<p>我们可以先不和Spring集成，也就是先不采用依赖注入，但是我们要做到像Dubbo一样，无需自己手动写代理对象，怎么做呢？那自然是要求所有的远程调用都遵循一套模板，<strong>把远程调用的信息放到一个RpcRequest对象里面，发给Server端，Server端解析之后就知道你要调用的是哪个RPC接口、以及入参是什么类型、入参的值又是什么</strong>，就像Dubbo的RpcInvocation：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcInvocation</span> <span class="keyword">implements</span> <span class="title">Invocation</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4355285085441097045L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[] parameterTypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] arguments;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; attachments;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Invoker&lt;?&gt; invoker;</span><br></pre></td></tr></table></figure>
<p>2、集成Spring<br>在实现了代理对象通用化之后，下一步就可以考虑集成Spring的IOC功能了，通过Spring来创建代理对象，这一点就需要对Spring的bean初始化有一定掌握了。</p>
<p>3、长连接or短连接<br>总不能每次要调用RPC接口时都去开启一个Socket建立连接吧？是不是可以保持若干个长连接，然后每次有rpc请求时，把请求放到任务队列中，然后由线程池去消费执行？只是一个思路，后续可以参考一下Dubbo是如何实现的。</p>
<p>4、 服务端线程池<br>我们现在的Server端，是单线程的，每次都要等一个请求处理完，才能去accept另一个socket的连接，这样性能肯定很差，是不是可以通过一个线程池，来实现同时处理多个RPC请求？同样只是一个思路。</p>
<p>5、服务注册中心<br>正如之前提到的，要调用服务，首先你需要一个服务注册中心，告诉你对方服务都有哪些实例。Dubbo的服务注册中心是可以配置的，官方推荐使用Zookeeper。如果使用Zookeeper的话，要怎样往上面注册实例，又要怎样获取实例，这些都是要实现的。</p>
<p>6、负载均衡<br>如何从多个实例里挑选一个出来，进行调用，这就要用到负载均衡了。负载均衡的策略肯定不只一种，要怎样把策略做成可配置的？又要如何实现这些策略？同样可以参考Dubbo，<a href="http://dubbo.apache.org/zh-cn/docs/user/quick-start.html" target="_blank" rel="noopener">Dubbo - 负载均衡</a></p>
<p>7、结果缓存<br>每次调用查询接口时都要真的去Server端查询吗？是不是要考虑一下支持缓存？</p>
<p>8、多版本控制<br>服务端接口修改了，旧的接口怎么办？</p>
<p>9、异步调用<br>客户端调用完接口之后，不想等待服务端返回，想去干点别的事，可以支持不？</p>
<p>10、优雅停机<br>服务端要停机了，还没处理完的请求，怎么办？</p>
<p>……</p>
<p>诸如此类的优化点还有很多，这也是为什么实现一个高性能高可用的RPC框架那么难的原因。</p>
<p>当然，我们现在已经有很多很不错的RPC框架可以参考了，我们完全可以借鉴一下前人的智慧。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>一本很棒的分布式书籍：《大型网站系统与Java中间件实践》</li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/quick-start.html" target="_blank" rel="noopener">Dubbo 使用文档</a></li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/quick-start.html" target="_blank" rel="noopener">Dubbo 源码开发手册</a></li>
</ul>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/09/19/java 如何实现一个简单的RPC/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/page/2/">
              <span>下一页</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 1 页 共 3 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Xiangjy. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/dx.png" alt="作者的图片">
        
            <h4 id="about-card-name">Xiangjy</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END--><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



    </body>
</html>
